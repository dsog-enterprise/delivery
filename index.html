<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=0.7, maximum-scale=1.0, user-scalable=no">
    
    <!-- App Version -->
    <meta name="app-version" content="2.3.0">
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#25D366">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="DSOG Delivery">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="DSOG Delivery">
    <meta name="msapplication-TileColor" content="#25D366">
    
    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="DSOG Delivery | WhatsApp Pickup Platform">
    <meta property="og:description" content="Professional delivery service with WhatsApp tracking">
    <meta property="og:image" content="https://i.postimg.cc/kMZ1jTww/Untitled-design-4-removebg-preview.png">
    <meta property="og:url" content="https://dsogstores.com/delivery">
    <meta property="og:type" content="website">
    
    <title>DSOG DELIVERY | WhatsApp Pickup Platform</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/delivery-manifest.json" crossorigin="use-credentials">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" sizes="180x180" href="https://i.postimg.cc/kMZ1jTww/Untitled-design-4-removebg-preview.png">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="https://i.postimg.cc/kMZ1jTww/Untitled-design-4-removebg-preview.png">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Sign-in SDK -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <!-- Google Maps API -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD-YeKzSqilwE0eAYQnYfK7H-kc0GjJiX4&libraries=places&callback=initMap" async defer></script>
    
    <!-- DELIVERY PLATFORM STYLES -->
    <style>
        :root {
            --primary-green: #25D366;
            --primary-black: #000000;
            --primary-gold: #D4AF37;
            --secondary-green: #128C7E;
            --secondary-black: #1a1a1a;
            --light-green: #5CD85A;
            --dark-green: #0A5C36;
            --light: #F5F5F5;
            --gray: #777777;
            --white: #FFFFFF;
            --text-primary: #222222;
            --text-secondary: #5a5a5a;
            --bg-primary: #ffffff;
            --bg-secondary: #f8f8f8;
            --border-color: #e0e0e0;
            --shadow-color: rgba(37, 211, 102, 0.08);
            --card-bg: #ffffff;
            --success: #25D366;
            --whatsapp-green: #25D366;
            --whatsapp-dark: #128C7E;
            --warning: #FFA500;
            --error: #FF4444;
            --info: #4285F4;
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 12px rgba(37, 211, 102, 0.1);
            --shadow-lg: 0 10px 25px rgba(37, 211, 102, 0.15);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            background: var(--bg-secondary);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
            min-height: 100vh;
            opacity: 0;
            animation: fadeIn 0.5s ease 0.5s forwards;
        }
        
        @keyframes fadeIn {
            to { opacity: 1; }
        }
        
        /* ===== PRELOADER ===== */
        .preloader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary-black) 0%, #0d0d0d 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }
        
        .preloader.hidden {
            opacity: 0;
            visibility: hidden;
        }
        
        .preloader-content {
            text-align: center;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            animation: fadeInUp 0.8s ease;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .preloader-logo {
            height: 100px;
            margin-bottom: 2rem;
            filter: drop-shadow(0 4px 12px rgba(37, 211, 102, 0.3));
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.9; }
        }
        
        .preloader-title {
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary-green), var(--primary-gold));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 1rem;
            letter-spacing: 1px;
        }
        
        .preloader-subtitle {
            font-size: 1.2rem;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 3rem;
            font-weight: 300;
        }
        
        .loading-progress {
            width: 100%;
            max-width: 300px;
            margin: 0 auto 2rem;
        }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 1rem;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-green), var(--primary-gold));
            border-radius: 10px;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .loading-text {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
            margin-bottom: 2rem;
        }
        
        .loading-steps {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 2rem;
            width: 100%;
            max-width: 300px;
        }
        
        .loading-step {
            display: flex;
            align-items: center;
            gap: 1rem;
            color: rgba(255, 255, 255, 0.6);
            transition: color 0.3s ease;
        }
        
        .loading-step.active {
            color: var(--primary-green);
        }
        
        .loading-step.completed {
            color: var(--primary-gold);
        }
        
        .step-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
        }
        
        .loading-step.active .step-icon {
            background: var(--primary-green);
            color: var(--white);
            animation: spin 1s linear infinite;
        }
        
        .loading-step.completed .step-icon {
            background: var(--primary-gold);
            color: var(--white);
        }
        
        .loading-step.completed .step-icon i {
            animation: checkMark 0.3s ease;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes checkMark {
            0% { transform: scale(0); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        .preloader-message {
            margin-top: 2rem;
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.9rem;
            font-style: italic;
        }
        
        /* Animated Background */
        .animated-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: -1;
        }
        
        .bg-circle {
            position: absolute;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(37, 211, 102, 0.1) 0%, rgba(37, 211, 102, 0) 70%);
            animation: float 20s infinite linear;
        }
        
        .bg-circle:nth-child(1) {
            width: 300px;
            height: 300px;
            top: -100px;
            left: -100px;
            animation-delay: 0s;
        }
        
        .bg-circle:nth-child(2) {
            width: 200px;
            height: 200px;
            bottom: -50px;
            right: 10%;
            animation-delay: -5s;
            animation-duration: 25s;
        }
        
        .bg-circle:nth-child(3) {
            width: 150px;
            height: 150px;
            top: 30%;
            right: -50px;
            animation-delay: -10s;
            animation-duration: 30s;
        }
        
        @keyframes float {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            33% { transform: translate(30px, 30px) rotate(120deg); }
            66% { transform: translate(-20px, 20px) rotate(240deg); }
        }
        
        /* STEP PROGRESS INDICATOR */
        .step-progress {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 2rem auto;
            max-width: 1400px;
            padding: 0 1.5rem;
            position: relative;
        }
        
        .step-progress::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--border-color);
            z-index: 1;
            transform: translateY(-50%);
        }
        
        .step-progress-bar {
            position: absolute;
            top: 50%;
            left: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-green), var(--primary-gold));
            z-index: 2;
            transform: translateY(-50%);
            transition: var(--transition);
            width: 0%;
        }
        
        .step {
            position: relative;
            z-index: 3;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            transition: var(--transition);
            flex: 1;
        }
        
        .step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--white);
            border: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: var(--text-secondary);
            transition: var(--transition);
            position: relative;
        }
        
        .step.active .step-circle {
            background: var(--primary-green);
            border-color: var(--primary-green);
            color: var(--white);
            transform: scale(1.1);
        }
        
        .step.completed .step-circle {
            background: var(--primary-green);
            border-color: var(--primary-green);
            color: var(--white);
        }
        
        .step.completed .step-circle::after {
            content: '✓';
            font-weight: bold;
        }
        
        .step-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-align: center;
            transition: var(--transition);
        }
        
        .step.active .step-label {
            color: var(--primary-green);
        }
        
        .step.completed .step-label {
            color: var(--text-primary);
        }
        
        /* STEP CONTENT CONTAINER */
        .step-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1.5rem;
            display: none;
            animation: fadeIn 0.5s ease;
        }
        
        .step-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* NAVIGATION BUTTONS */
        .step-navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 2rem;
            padding: 1rem 0;
            border-top: 1px solid var(--border-color);
        }
        
        .step-btn {
            padding: 0.8rem 2rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1rem;
            min-width: 140px;
            justify-content: center;
        }
        
        .step-btn.prev {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        
        .step-btn.prev:hover {
            background: var(--border-color);
        }
        
        .step-btn.next {
            background: var(--primary-green);
            color: var(--white);
        }
        
        .step-btn.next:hover {
            background: var(--secondary-green);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .step-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .step-btn.confirm {
            background: linear-gradient(135deg, var(--primary-green), var(--secondary-green));
            color: var(--white);
            width: 100%;
            padding: 1rem;
            font-size: 1.1rem;
        }
        
        .step-btn.confirm:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(37, 211, 102, 0.4);
        }
        
        /* FIXED HEADER */
        header {
            background: var(--primary-black);
            padding: 1rem 1.5rem;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 20px rgba(0,0,0,0.2);
            border-bottom: 3px solid var(--primary-green);
            display: none;
        }
        
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }
        
        .logo {
            height: 35px;
            filter: drop-shadow(0 2px 4px rgba(37, 211, 102, 0.3));
        }
        
        /* User Profile in Header */
        .user-profile-header {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            margin-left: auto;
            margin-right: 1rem;
            cursor: pointer;
            display: none;
        }
        
        .user-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-green), var(--primary-gold));
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-weight: bold;
            font-size: 0.9rem;
            border: 2px solid var(--primary-green);
            overflow: hidden;
            background-size: cover;
            background-position: center;
        }
        
        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .user-name {
            color: var(--white);
            font-size: 0.9rem;
            font-weight: 500;
            display: none;
        }
        
        @media (min-width: 768px) {
            .user-name {
                display: block;
            }
        }
        
        /* Google Sign-in Container */
        .gsi-container {
            display: flex;
            justify-content: center;
            margin: 1rem 0;
        }
        
        /* Hamburger Menu */
        .hamburger {
            display: none;
            flex-direction: column;
            cursor: pointer;
            background: none;
            border: none;
            padding: 8px;
            position: relative;
            z-index: 1001;
            transition: var(--transition);
        }
        
        .hamburger span {
            width: 25px;
            height: 2px;
            background: var(--white);
            margin: 4px 0;
            transition: var(--transition);
            border-radius: 2px;
        }
        
        .hamburger.active span:nth-child(1) {
            transform: rotate(-45deg) translate(-6px, 6px);
            background: var(--primary-green);
        }
        
        .hamburger.active span:nth-child(2) {
            opacity: 0;
        }
        
        .hamburger.active span:nth-child(3) {
            transform: rotate(45deg) translate(-6px, -6px);
            background: var(--primary-green);
        }
        
        /* Desktop Navigation */
        .nav-links {
            display: flex;
            gap: 2rem;
            align-items: center;
        }
        
        .nav-links a {
            color: var(--white);
            text-decoration: none;
            font-weight: 500;
            transition: var(--transition);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
            padding: 0.4rem 0;
        }
        
        .nav-links a::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0;
            height: 2px;
            background: var(--primary-green);
            transition: var(--transition);
        }
        
        .nav-links a:hover {
            color: var(--primary-green);
        }
        
        .nav-links a:hover::after {
            width: 100%;
        }
        
        .nav-links a.active {
            color: var(--primary-green);
        }
        
        .nav-links a.active::after {
            width: 100%;
        }
        
        /* Mobile Menu */
        .mobile-menu {
            position: fixed;
            top: 0;
            right: -100%;
            width: 280px;
            height: 100vh;
            background: var(--primary-black);
            padding: 5rem 2rem 2rem;
            transition: var(--transition);
            z-index: 999;
            box-shadow: -5px 0 25px rgba(0,0,0,0.3);
            overflow-y: auto;
        }
        
        .mobile-menu.active {
            right: 0;
        }
        
        .mobile-nav-links {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .mobile-nav-links a {
            color: var(--white);
            text-decoration: none;
            font-size: 1.1rem;
            padding: 1rem 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            transition: var(--transition);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .mobile-nav-links a:hover {
            color: var(--primary-green);
            padding-left: 10px;
        }
        
        .menu-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 998;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
        }
        
        .menu-backdrop.active {
            opacity: 1;
            visibility: visible;
        }
        
        .close-menu {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            color: var(--white);
            font-size: 1.5rem;
            cursor: pointer;
            transition: var(--transition);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }
        
        .close-menu:hover {
            background: var(--primary-green);
            transform: rotate(90deg);
        }
        
        /* INSTALL APP BUTTON */
        .install-app-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--primary-green);
            color: var(--white);
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 30px;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
            text-decoration: none;
        }
        
        .install-app-btn:hover {
            background: var(--secondary-green);
            transform: translateY(-2px);
        }
        
        /* ENHANCED CHARGE CALCULATOR */
        .charge-calculator-card {
            background: var(--white);
            border-radius: 15px;
            padding: 2rem;
            box-shadow: var(--shadow-lg);
            margin: 1.5rem 0;
            border: 3px solid var(--primary-gold);
            position: relative;
            overflow: hidden;
        }
        
        .charge-calculator-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-green), var(--primary-gold));
        }
        
        .calculator-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .calculator-header i {
            color: var(--primary-gold);
            font-size: 2rem;
        }
        
        .calculator-header h3 {
            margin: 0;
            color: var(--primary-black);
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .calculator-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .calculator-input-group {
            position: relative;
        }
        
        .calculator-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 1rem;
        }
        
        .calculator-label i {
            margin-right: 0.5rem;
            color: var(--primary-green);
        }
        
        .calculator-input {
            width: 100%;
            padding: 1rem;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 1rem;
            transition: var(--transition);
            background: var(--bg-secondary);
        }
        
        .calculator-input:focus {
            outline: none;
            border-color: var(--primary-green);
            background: var(--white);
            box-shadow: 0 0 0 4px rgba(37, 211, 102, 0.1);
        }
        
        .calculator-input.select {
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23777777' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1em;
        }
        
        .calculator-result {
            background: linear-gradient(135deg, rgba(37, 211, 102, 0.08), rgba(212, 175, 55, 0.08));
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 1.5rem;
            border: 2px solid rgba(37, 211, 102, 0.2);
            animation: slideUp 0.4s ease;
        }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .result-header {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            margin-bottom: 1rem;
        }
        
        .result-header h4 {
            margin: 0;
            color: var(--primary-green);
            font-size: 1.2rem;
        }
        
        .result-header i {
            color: var(--primary-green);
        }
        
        .charge-breakdown {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .charge-item {
            background: var(--white);
            padding: 1rem;
            border-radius: 8px;
            border-left: 4px solid var(--primary-green);
            transition: var(--transition);
        }
        
        .charge-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }
        
        .charge-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 0.3rem;
        }
        
        .charge-value {
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--text-primary);
        }
        
        .charge-total {
            background: linear-gradient(135deg, var(--primary-green), var(--secondary-green));
            color: var(--white);
            font-weight: 700;
            font-size: 1.2rem;
            border-left: 4px solid var(--primary-gold);
        }
        
        .charge-total .charge-value {
            color: var(--white);
            font-size: 1.3rem;
        }
        
        .charge-note {
            font-size: 0.9rem;
            color: var(--text-secondary);
            text-align: center;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px dashed var(--border-color);
        }
        
        /* ENHANCED PROFESSIONAL GOOGLE SIGN-IN MODAL */
        .google-signin-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.98);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2005;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
            padding: 2rem;
            backdrop-filter: blur(10px);
            display: none;
        }
        
        .google-signin-modal.active {
            opacity: 1;
            visibility: visible;
            display: flex;
        }
        
        .google-signin-content {
            background: var(--white);
            border-radius: 20px;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            animation: modalSlideIn 0.4s ease;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        @media (min-width: 992px) {
            .google-signin-content {
                flex-direction: row;
                min-height: 600px;
            }
        }
        
        /* Left Panel - Branding */
        .signin-left-panel {
            flex: 1;
            background: linear-gradient(135deg, var(--primary-black) 0%, var(--secondary-black) 100%);
            color: var(--white);
            padding: 3rem 2rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .signin-left-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('https://i.postimg.cc/kMZ1jTww/Untitled-design-4-removebg-preview.png') center/contain no-repeat;
            opacity: 0.05;
        }
        
        .signin-logo-container {
            position: relative;
            z-index: 1;
            margin-bottom: 2rem;
        }
        
        .signin-logo {
            height: 80px;
            filter: drop-shadow(0 4px 8px rgba(37, 211, 102, 0.3));
            margin-bottom: 1rem;
        }
        
        .signin-brand-title {
            font-size: 2.2rem;
            font-weight: 800;
            color: var(--primary-green);
            margin-bottom: 0.5rem;
            letter-spacing: 1px;
            text-transform: uppercase;
        }
        
        .signin-brand-subtitle {
            font-size: 1.1rem;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 2rem;
            font-weight: 400;
            max-width: 300px;
        }
        
        .signin-features {
            list-style: none;
            margin-top: 2rem;
            text-align: left;
            width: 100%;
            max-width: 300px;
        }
        
        .signin-features li {
            margin-bottom: 1rem;
            padding-left: 1.8rem;
            position: relative;
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.95rem;
        }
        
        .signin-features li::before {
            content: '✓';
            position: absolute;
            left: 0;
            color: var(--primary-green);
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        .signin-divider {
            width: 60px;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-green), var(--primary-gold));
            margin: 2rem auto;
            border-radius: 3px;
        }
        
        /* Right Panel - Sign-in Form */
        .signin-right-panel {
            flex: 1;
            padding: 3rem 2.5rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
            background: var(--white);
        }
        
        .signin-header {
            margin-bottom: 2.5rem;
            text-align: center;
        }
        
        .signin-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.8rem;
            line-height: 1.3;
        }
        
        .signin-subtitle {
            font-size: 1rem;
            color: var(--text-secondary);
            line-height: 1.6;
            max-width: 400px;
            margin: 0 auto;
        }
        
        .signin-form-container {
            margin: 2rem 0;
        }
        
        .signin-requirements {
            background: linear-gradient(135deg, rgba(37, 211, 102, 0.05), rgba(212, 175, 55, 0.05));
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            border: 1px solid rgba(37, 211, 102, 0.1);
        }
        
        .signin-requirements h3 {
            color: var(--primary-green);
            margin-bottom: 1rem;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .requirements-list {
            list-style-type: none;
        }
        
        .requirements-list li {
            margin-bottom: 0.8rem;
            padding-left: 1.5rem;
            position: relative;
            color: var(--text-secondary);
            font-size: 0.95rem;
            line-height: 1.5;
        }
        
        .requirements-list li::before {
            content: '•';
            position: absolute;
            left: 0;
            color: var(--primary-green);
            font-weight: bold;
            font-size: 1.2rem;
        }
        
        .signin-button-container {
            margin: 2rem 0;
            text-align: center;
        }
        
        .google-signin-button-wrapper {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }
        
        .signin-or-divider {
            display: flex;
            align-items: center;
            margin: 1.5rem 0;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        .signin-or-divider::before,
        .signin-or-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--border-color);
        }
        
        .signin-or-divider span {
            padding: 0 1rem;
        }
        
        .signin-security-note {
            background: rgba(66, 133, 244, 0.05);
            padding: 1.2rem;
            border-radius: 10px;
            border-left: 4px solid var(--info);
            margin-top: 2rem;
            font-size: 0.9rem;
            color: var(--text-secondary);
            line-height: 1.6;
        }
        
        .signin-security-note strong {
            color: var(--info);
            font-weight: 600;
        }
        
        .signin-footer {
            margin-top: 2rem;
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.85rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border-color);
        }
        
        /* Custom Google Button Styling */
        .custom-google-button {
            background: var(--white);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 0.9rem 2rem;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.8rem;
            min-width: 280px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        
        .custom-google-button:hover {
            background: #f8f9fa;
            border-color: var(--info);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
        }
        
        .custom-google-button:active {
            transform: translateY(0);
        }
        
        .google-button-icon {
            width: 20px;
            height: 20px;
            background: conic-gradient(
                from 0deg at 50% 50%,
                #EA4335 0deg 90deg,
                #FBBC05 90deg 180deg,
                #34A853 180deg 270deg,
                #4285F4 270deg 360deg
            );
            border-radius: 2px;
            position: relative;
        }
        
        .google-button-icon::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            right: 2px;
            bottom: 2px;
            background: var(--white);
            border-radius: 1px;
        }
        
        .google-button-icon::after {
            content: 'G';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--info);
            font-weight: bold;
            font-size: 0.9rem;
        }
        
        .signin-help {
            margin-top: 1rem;
            font-size: 0.85rem;
            color: var(--text-secondary);
            text-align: center;
        }
        
        .signin-help a {
            color: var(--primary-green);
            text-decoration: none;
            font-weight: 600;
        }
        
        .signin-help a:hover {
            text-decoration: underline;
        }
        
        /* User Registration Modal */
        .user-registration-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2006;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
            padding: 1rem;
            display: none;
        }
        
        .user-registration-modal.active {
            opacity: 1;
            visibility: visible;
            display: flex;
        }
        
        .registration-content {
            background: var(--white);
            border-radius: 15px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            animation: modalSlideIn 0.3s ease;
            border: 3px solid var(--primary-green);
            box-shadow: var(--shadow-lg);
        }
        
        .registration-header {
            background: var(--primary-black);
            color: var(--white);
            padding: 1.5rem;
            border-radius: 12px 12px 0 0;
            text-align: center;
            border-bottom: 3px solid var(--primary-green);
            position: relative;
        }
        
        .registration-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: var(--primary-green);
            color: var(--white);
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }
        
        .registration-close:hover {
            background: var(--secondary-green);
            transform: rotate(90deg);
        }
        
        .registration-body {
            padding: 2rem;
        }
        
        .registration-form .form-group {
            margin-bottom: 1.5rem;
        }
        
        .registration-form label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .registration-form .form-control {
            width: 100%;
            padding: 0.8rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            transition: var(--transition);
        }
        
        .registration-form .form-control:focus {
            outline: none;
            border-color: var(--primary-green);
            box-shadow: 0 0 0 3px rgba(37, 211, 102, 0.1);
        }
        
        .registration-actions {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }
        
        .registration-btn {
            flex: 1;
            padding: 1rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .registration-btn-primary {
            background: var(--primary-green);
            color: var(--white);
        }
        
        .registration-btn-primary:hover {
            background: var(--secondary-green);
            transform: translateY(-2px);
        }
        
        .registration-btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        
        .registration-btn-secondary:hover {
            background: var(--border-color);
        }
        
        /* User Profile Modal */
        .user-profile-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2004;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
            padding: 1rem;
            display: none;
        }
        
        .user-profile-modal.active {
            opacity: 1;
            visibility: visible;
            display: flex;
        }
        
        .profile-content {
            background: var(--white);
            border-radius: 15px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            animation: modalSlideIn 0.3s ease;
            border: 3px solid var(--primary-green);
            box-shadow: var(--shadow-lg);
        }
        
        .profile-header {
            background: var(--primary-black);
            color: var(--white);
            padding: 1.5rem;
            border-radius: 12px 12px 0 0;
            text-align: center;
            border-bottom: 3px solid var(--primary-green);
            position: relative;
        }
        
        .profile-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: var(--primary-green);
            color: var(--white);
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }
        
        .profile-close:hover {
            background: var(--secondary-green);
            transform: rotate(90deg);
        }
        
        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-green), var(--primary-gold));
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-size: 2rem;
            font-weight: bold;
            margin: 0 auto 1rem;
            border: 3px solid var(--primary-green);
            overflow: hidden;
            background-size: cover;
            background-position: center;
        }
        
        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .profile-body {
            padding: 2rem;
        }
        
        .profile-info {
            margin-bottom: 2rem;
        }
        
        .profile-actions {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .profile-btn {
            padding: 1rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .profile-btn-primary {
            background: var(--primary-green);
            color: var(--white);
        }
        
        .profile-btn-primary:hover {
            background: var(--secondary-green);
            transform: translateY(-2px);
        }
        
        .profile-btn-google {
            background: var(--info);
            color: var(--white);
        }
        
        .profile-btn-google:hover {
            background: #3367d6;
            transform: translateY(-2px);
        }
        
        .profile-btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        
        .profile-btn-secondary:hover {
            background: var(--border-color);
        }
        
        .sign-out-btn {
            background: var(--error);
            color: var(--white);
        }
        
        .sign-out-btn:hover {
            background: #d3342d;
            transform: translateY(-2px);
        }
        
        /* PWA INSTALL PROMPT */
        .pwa-install-prompt {
            position: fixed;
            bottom: 100px;
            left: 20px;
            right: 20px;
            background: var(--primary-black);
            color: var(--white);
            padding: 1.2rem;
            border-radius: 15px;
            box-shadow: var(--shadow-lg);
            z-index: 2000;
            display: none;
            flex-direction: column;
            gap: 1rem;
            border: 2px solid var(--primary-green);
            animation: slideUp 0.3s ease;
            max-width: 400px;
            margin: 0 auto;
        }
        
        .pwa-install-header {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .pwa-install-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            background: var(--primary-green);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            border: 2px solid var(--primary-gold);
        }
        
        .pwa-install-title {
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--white);
        }
        
        .pwa-install-subtitle {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-top: 0.2rem;
        }
        
        .pwa-install-buttons {
            display: flex;
            gap: 0.8rem;
            justify-content: flex-end;
        }
        
        .pwa-install-btn {
            padding: 0.7rem 1.5rem;
            border: none;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.9rem;
        }
        
        .pwa-install-primary {
            background: var(--primary-green);
            color: var(--white);
        }
        
        .pwa-install-primary:hover {
            background: var(--secondary-green);
            transform: translateY(-2px);
        }
        
        .pwa-install-secondary {
            background: transparent;
            color: var(--white);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .pwa-install-secondary:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .pwa-install-close {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            color: var(--white);
            opacity: 0.7;
            cursor: pointer;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: var(--transition);
        }
        
        .pwa-install-close:hover {
            background: var(--primary-green);
            opacity: 1;
        }
        
        /* LOCATION INPUT SECTION */
        .location-card {
            background: var(--white);
            border-radius: 15px;
            padding: 2rem;
            box-shadow: var(--shadow-lg);
            margin: 1.5rem 0;
            border: 3px solid var(--primary-green);
        }
        
        .location-card-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .location-card-header i {
            color: var(--primary-green);
            font-size: 2rem;
        }
        
        .location-card-header h3 {
            margin: 0;
            color: var(--primary-black);
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .location-input-group {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .location-input {
            flex: 1;
            padding: 1rem;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 1rem;
            transition: var(--transition);
            background: var(--bg-secondary);
        }
        
        .location-input:focus {
            outline: none;
            border-color: var(--primary-green);
            background: var(--white);
            box-shadow: 0 0 0 4px rgba(37, 211, 102, 0.1);
        }
        
        .location-btn {
            background: var(--primary-green);
            color: var(--white);
            border: none;
            padding: 1rem 2rem;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            min-width: 150px;
        }
        
        .location-btn:hover {
            background: var(--secondary-green);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .current-location-display {
            margin-top: 1.5rem;
            padding: 1.5rem;
            background: linear-gradient(135deg, rgba(37, 211, 102, 0.08), rgba(212, 175, 55, 0.08));
            border-radius: 12px;
            border: 2px solid rgba(37, 211, 102, 0.2);
            display: none;
            animation: fadeIn 0.5s ease;
        }
        
        .current-location-display.active {
            display: block;
        }
        
        .location-status {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            margin-bottom: 0.8rem;
        }
        
        .location-status i {
            color: var(--primary-green);
            font-size: 1.2rem;
        }
        
        /* PACKAGE TYPE SELECTION */
        .package-selection-card {
            background: var(--white);
            border-radius: 15px;
            padding: 2rem;
            box-shadow: var(--shadow-lg);
            margin: 1.5rem 0;
            border: 3px solid var(--primary-gold);
        }
        
        .package-selection-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .package-selection-header i {
            color: var(--primary-gold);
            font-size: 2rem;
        }
        
        .package-selection-header h3 {
            margin: 0;
            color: var(--primary-black);
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .package-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }
        
        .package-card {
            background: var(--bg-secondary);
            border: 3px solid var(--border-color);
            border-radius: 12px;
            padding: 2rem 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            position: relative;
        }
        
        .package-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary-green);
            box-shadow: var(--shadow-lg);
        }
        
        .package-card.selected {
            background: linear-gradient(135deg, rgba(37, 211, 102, 0.1), rgba(212, 175, 55, 0.05));
            border-color: var(--primary-green);
            color: var(--primary-green);
        }
        
        .package-icon {
            font-size: 2.5rem;
            color: var(--primary-green);
            margin-bottom: 0.5rem;
        }
        
        .package-card.selected .package-icon {
            color: var(--secondary-green);
        }
        
        .package-name {
            font-weight: 700;
            font-size: 1.2rem;
            color: var(--text-primary);
        }
        
        .package-size {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        
        .package-price {
            font-size: 1rem;
            color: var(--primary-gold);
            font-weight: 600;
            margin-top: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(212, 175, 55, 0.1);
            border-radius: 20px;
        }
        
        .package-card.selected .package-price {
            color: var(--white);
            background: var(--primary-green);
        }
        
        /* ASSISTANT SELECTION */
        .assistant-selection-card {
            background: var(--white);
            border-radius: 15px;
            padding: 2rem;
            box-shadow: var(--shadow-lg);
            margin: 1.5rem 0;
            border: 3px solid var(--primary-green);
        }
        
        .assistant-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border-color);
        }
        
        .assistant-header h3 {
            margin: 0;
            color: var(--primary-black);
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .assistant-sorting {
            display: flex;
            gap: 0.5rem;
        }
        
        .sort-btn {
            padding: 0.6rem 1.2rem;
            border: 2px solid var(--border-color);
            background: var(--white);
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .sort-btn:hover {
            background: var(--bg-secondary);
        }
        
        .sort-btn.active {
            background: var(--primary-green);
            color: var(--white);
            border-color: var(--primary-green);
        }
        
        .assistants-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }
        
        .assistant-card {
            background: var(--bg-secondary);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            transition: var(--transition);
            border: 2px solid var(--border-color);
            cursor: pointer;
        }
        
        .assistant-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary-green);
        }
        
        .assistant-card.selected {
            background: linear-gradient(135deg, rgba(37, 211, 102, 0.1), rgba(37, 211, 102, 0.05));
            border-color: var(--primary-green);
        }
        
        .assistant-card-header {
            background: linear-gradient(135deg, var(--primary-black), var(--secondary-black));
            color: var(--white);
            padding: 1.5rem;
            position: relative;
        }
        
        .assistant-card-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-green), var(--primary-gold));
        }
        
        .assistant-status {
            position: absolute;
            top: 1rem;
            right: 1rem;
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-available {
            background: var(--success);
            color: var(--white);
        }
        
        .status-busy {
            background: var(--warning);
            color: var(--white);
        }
        
        .assistant-name {
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: var(--white);
        }
        
        .assistant-id {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-bottom: 0.5rem;
        }
        
        .assistant-vehicle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.95rem;
        }
        
        .assistant-card-body {
            padding: 1.5rem;
        }
        
        .assistant-info {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .assistant-detail {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .assistant-detail span:first-child {
            font-weight: 600;
            color: var(--text-secondary);
        }
        
        .assistant-rating {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            color: var(--primary-gold);
        }
        
        .assistant-actions {
            display: flex;
            gap: 1rem;
        }
        
        .assign-btn {
            flex: 1;
            background: var(--primary-green);
            color: var(--white);
            border: none;
            padding: 0.8rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .assign-btn:hover:not(:disabled) {
            background: var(--secondary-green);
            transform: translateY(-2px);
        }
        
        .assign-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .whatsapp-btn {
            width: 50px;
            height: 50px;
            background: var(--whatsapp-green);
            color: var(--white);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            font-size: 1.3rem;
        }
        
        .whatsapp-btn:hover {
            background: var(--whatsapp-dark);
            transform: scale(1.1);
        }
        
        .distance-indicator {
            margin-top: 0.5rem;
            font-size: 0.9rem;
            color: var(--primary-green);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        /* FORM STYLES FOR STEP 1 */
        .form-card {
            background: var(--white);
            border-radius: 15px;
            padding: 2rem;
            box-shadow: var(--shadow-lg);
            margin: 1.5rem 0;
            border: 3px solid var(--primary-green);
        }
        
        .form-card-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .form-card-header i {
            color: var(--primary-green);
            font-size: 2rem;
        }
        
        .form-card-header h3 {
            margin: 0;
            color: var(--primary-black);
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .form-group {
            position: relative;
        }
        
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 1rem;
        }
        
        .form-label i {
            margin-right: 0.5rem;
            color: var(--primary-green);
        }
        
        .form-control {
            width: 100%;
            padding: 1rem;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 1rem;
            transition: var(--transition);
            background: var(--bg-secondary);
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary-green);
            background: var(--white);
            box-shadow: 0 0 0 4px rgba(37, 211, 102, 0.1);
        }
        
        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }
        
        .char-count {
            position: absolute;
            bottom: 10px;
            right: 10px;
            font-size: 0.8rem;
            color: var(--gray);
            background: rgba(255, 255, 255, 0.9);
            padding: 0.3rem 0.6rem;
            border-radius: 10px;
        }
        
        /* REVIEW STEP */
        .review-card {
            background: var(--white);
            border-radius: 15px;
            padding: 2rem;
            box-shadow: var(--shadow-lg);
            margin: 1.5rem 0;
            border: 3px solid var(--primary-gold);
        }
        
        .review-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .review-header i {
            color: var(--primary-gold);
            font-size: 2rem;
        }
        
        .review-header h3 {
            margin: 0;
            color: var(--primary-black);
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .review-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .review-item {
            background: var(--bg-secondary);
            padding: 1.5rem;
            border-radius: 10px;
            border-left: 4px solid var(--primary-green);
        }
        
        .review-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        
        .review-value {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 1.1rem;
            line-height: 1.4;
        }
        
        .review-charges {
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.1), rgba(37, 211, 102, 0.1));
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 1.5rem;
            border: 2px solid rgba(212, 175, 55, 0.2);
        }
        
        .review-charges h4 {
            color: var(--primary-gold);
            margin-bottom: 1rem;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        /* Confirmation Modal */
        .confirmation-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2002;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
            padding: 1rem;
            display: none;
        }
        
        .confirmation-modal.active {
            opacity: 1;
            visibility: visible;
            display: flex;
        }
        
        .confirmation-content {
            background: var(--white);
            border-radius: 15px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            animation: modalSlideIn 0.3s ease;
            border: 2px solid var(--primary-green);
        }
        
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
        
        .confirmation-header {
            background: var(--primary-black);
            color: var(--white);
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--primary-green);
        }
        
        .confirmation-header h2 {
            font-size: 1.5rem;
            color: var(--primary-green);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .confirmation-close {
            background: var(--primary-green);
            color: var(--white);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }
        
        .confirmation-close:hover {
            background: var(--secondary-green);
            transform: rotate(90deg);
        }
        
        .confirmation-body {
            padding: 2rem;
        }
        
        .confirmation-details {
            background: var(--bg-secondary);
            padding: 1.5rem;
            border-radius: 10px;
            margin-bottom: 2rem;
            border: 1px solid var(--border-color);
        }
        
        .confirmation-details h3 {
            color: var(--primary-green);
            margin-bottom: 1rem;
            font-size: 1.2rem;
        }
        
        .confirmation-actions {
            display: flex;
            gap: 1rem;
        }
        
        .confirm-btn {
            flex: 1;
            background: var(--primary-green);
            color: var(--white);
            border: none;
            padding: 1rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .confirm-btn:hover {
            background: var(--secondary-green);
            transform: translateY(-2px);
        }
        
        .cancel-btn {
            flex: 1;
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            padding: 1rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .cancel-btn:hover {
            background: var(--border-color);
        }
        
        /* Loading States */
        .loading {
            text-align: center;
            padding: 3rem;
            display: none;
        }
        
        .loading.visible {
            display: block;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(37, 211, 102, 0.1);
            border-top: 3px solid var(--primary-green);
            border-right: 3px solid var(--primary-green);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1.5rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Notification */
        .notification {
            position: fixed;
            top: 100px;
            right: 20px;
            background: var(--primary-green);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 30px;
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            animation: slideIn 0.3s ease;
            max-width: 300px;
            font-weight: 600;
            border: 2px solid var(--primary-gold);
            backdrop-filter: blur(10px);
            display: none;
        }
        
        .notification.show {
            display: block;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--primary-black);
            backdrop-filter: blur(20px);
            border-top: 2px solid var(--primary-green);
            z-index: 1000;
            box-shadow: 0 -10px 30px rgba(0,0,0,0.3);
            padding: 0.5rem;
            display: none;
        }
        
        .bottom-nav-container {
            display: flex;
            justify-content: space-around;
            align-items: center;
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: var(--gray);
            padding: 0.5rem;
            border-radius: 10px;
            transition: var(--transition);
            position: relative;
            min-width: 70px;
            cursor: pointer;
            background: transparent;
            border: none;
        }
        
        .nav-item.active {
            color: var(--white);
            background: linear-gradient(135deg, var(--primary-green) 0%, var(--secondary-green) 100%);
        }
        
        .nav-icon {
            font-size: 1.2rem;
            margin-bottom: 0.3rem;
        }
        
        .nav-label {
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Main Content Overlay when not signed in */
        .content-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.98);
            z-index: 1999;
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--white);
            text-align: center;
            padding: 2rem;
            backdrop-filter: blur(10px);
            display: none;
        }
        
        .content-overlay h2 {
            font-size: 2rem;
            color: var(--primary-gold);
            margin-bottom: 1rem;
        }
        
        .content-overlay p {
            font-size: 1.2rem;
            margin-bottom: 2rem;
            opacity: 0.8;
        }
        
        /* No Assistants Message */
        .no-assistants {
            text-align: center;
            padding: 3rem;
            background: var(--white);
            border-radius: 12px;
            border: 2px dashed var(--border-color);
        }
        
        .no-assistants i {
            font-size: 3rem;
            color: var(--gray);
            margin-bottom: 1rem;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .hamburger {
                display: flex;
            }
            
            .nav-links {
                display: none;
            }
            
            .user-name {
                display: none;
            }
            
            .step-progress {
                padding: 0 1rem;
            }
            
            .step-circle {
                width: 35px;
                height: 35px;
                font-size: 0.9rem;
            }
            
            .step-label {
                font-size: 0.75rem;
            }
            
            .location-input-group {
                flex-direction: column;
            }
            
            .location-btn {
                width: 100%;
            }
            
            .package-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .assistants-grid {
                grid-template-columns: 1fr;
            }
            
            .calculator-grid,
            .form-grid,
            .review-grid {
                grid-template-columns: 1fr;
            }
            
            .assistant-sorting {
                flex-wrap: wrap;
            }
            
            .confirmation-actions {
                flex-direction: column;
            }
            
            .google-signin-content {
                flex-direction: column;
            }
            
            .signin-left-panel,
            .signin-right-panel {
                padding: 2rem 1.5rem;
            }
            
            .signin-brand-title {
                font-size: 1.8rem;
            }
            
            .signin-title {
                font-size: 1.5rem;
            }
            
            .step-btn {
                padding: 0.8rem 1.5rem;
                min-width: 120px;
            }
            
            /* Preloader mobile */
            .preloader-title {
                font-size: 2rem;
            }
            
            .preloader-subtitle {
                font-size: 1rem;
            }
            
            .preloader-logo {
                height: 80px;
            }
        }
        
        @media (max-width: 480px) {
            .package-grid {
                grid-template-columns: 1fr;
            }
            
            .nav-item {
                min-width: 60px;
                padding: 0.4rem 0.3rem;
            }
            
            .nav-icon {
                font-size: 1rem;
            }
            
            .nav-label {
                font-size: 0.6rem;
            }
            
            .custom-google-button {
                min-width: 100%;
                padding: 0.8rem 1.5rem;
            }
            
            .step-progress {
                padding: 0 0.5rem;
            }
            
            .step-label {
                font-size: 0.7rem;
            }
        }
    </style>
</head>
<body>
    <!-- PRELOADER -->
    <div class="preloader" id="preloader">
        <div class="animated-bg">
            <div class="bg-circle"></div>
            <div class="bg-circle"></div>
            <div class="bg-circle"></div>
        </div>
        <div class="preloader-content">
            <img src="https://i.postimg.cc/kMZ1jTww/Untitled-design-4-removebg-preview.png" alt="DSOG Delivery" class="preloader-logo">
            <h1 class="preloader-title">DSOG DELIVERY</h1>
            <p class="preloader-subtitle">WhatsApp-Powered Delivery Platform</p>
            
            <div class="loading-progress">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="loading-text">
                    <span>Loading Platform</span>
                    <span id="progressPercent">0%</span>
                </div>
            </div>
            
            <div class="loading-steps">
                <div class="loading-step" id="step1Loading">
                    <div class="step-icon"><i class="fas fa-cog"></i></div>
                    <span>Initializing platform...</span>
                </div>
                <div class="loading-step" id="step2Loading">
                    <div class="step-icon"><i class="fas fa-user-shield"></i></div>
                    <span>Checking authentication...</span>
                </div>
                <div class="loading-step" id="step3Loading">
                    <div class="step-icon"><i class="fas fa-map-marker-alt"></i></div>
                    <span>Loading location services...</span>
                </div>
                <div class="loading-step" id="step4Loading">
                    <div class="step-icon"><i class="fas fa-truck"></i></div>
                    <span>Connecting to assistants...</span>
                </div>
            </div>
            
            <p class="preloader-message">Professional delivery at your fingertips</p>
        </div>
    </div>

    <!-- ENHANCED PROFESSIONAL GOOGLE SIGN-IN MODAL -->
    <div class="google-signin-modal" id="googleSigninModal">
        <div class="google-signin-content">
            <!-- Left Panel - Branding -->
            <div class="signin-left-panel">
                <div class="signin-logo-container">
                    <img src="https://i.postimg.cc/kMZ1jTww/Untitled-design-4-removebg-preview.png" alt="DSOG Delivery" class="signin-logo">
                    <h1 class="signin-brand-title">DSOG DELIVERY</h1>
                    <p class="signin-brand-subtitle">WhatsApp-Based Delivery Platform</p>
                </div>
                
                <div class="signin-divider"></div>
                
                <ul class="signin-features">
                    <li>Direct WhatsApp communication with assistants</li>
                    <li>Manual location entry for pickup</li>
                    <li>See only assistants in your area</li>
                    <li>Real-time WhatsApp tracking</li>
                    <li>Secure customer data protection</li>
                </ul>
                
                <div style="margin-top: auto; text-align: center; width: 100%;">
                    <p style="font-size: 0.9rem; color: rgba(255, 255, 255, 0.7); margin-top: 2rem;">
                        <i class="fas fa-map-marker-alt" style="margin-right: 0.5rem;"></i>
                        Location-based assistant matching
                    </p>
                </div>
            </div>
            
            <!-- Right Panel - Sign-in Form -->
            <div class="signin-right-panel">
                <div class="signin-header">
                    <h2 class="signin-title">Welcome to DSOG Delivery Platform</h2>
                    <p class="signin-subtitle">
                        Sign in with your Google account to request pickups and track deliveries via WhatsApp.
                        Enter your location to see only available delivery assistants in your area.
                    </p>
                </div>
                
                <div class="signin-form-container">
                    <div class="signin-requirements">
                        <h3><i class="fas fa-shield-alt"></i> Platform Requirements</h3>
                        <ul class="requirements-list">
                            <li>Valid Google account for authentication</li>
                            <li>WhatsApp installed on your device</li>
                            <li>Exact location entry for pickup</li>
                            <li>Package details must be accurate</li>
                            <li>Delivery-specific use only</li>
                        </ul>
                    </div>
                    
                    <div class="signin-button-container">
                        <div class="google-signin-button-wrapper">
                            <p style="color: var(--text-secondary); margin-bottom: 1rem; font-size: 0.95rem;">
                                <i class="fas fa-info-circle"></i> Click below to sign in securely with Google
                            </p>
                            
                            <!-- Custom Google Sign-in Button -->
                            <button class="custom-google-button" onclick="triggerGoogleSignIn()">
                                <span class="google-button-icon"></span>
                                Sign in with Google
                            </button>
                            
                            <!-- Hidden Google Sign-in Button (will be triggered by custom button) -->
                            <div id="googleSignInButton" style="display: none;"></div>
                            
                            <div class="signin-or-divider">
                                <span>or</span>
                            </div>
                            
                            <p style="color: var(--text-secondary); font-size: 0.9rem; text-align: center;">
                                For assistance, contact 
                                <a href="mailto:care.dsogstores@gmail.com" style="color: var(--primary-green); font-weight: 600;">support</a>
                            </p>
                        </div>
                    </div>
                    
                    <div class="signin-security-note">
                        <i class="fas fa-lock"></i>
                        <strong>Security Notice:</strong> Your Google authentication ensures secure access to the delivery platform. 
                        All communications are encrypted and your data is protected according to enterprise security standards.
                    </div>
                </div>
                
                <div class="signin-footer">
                    <p>
                        <i class="fas fa-copyright"></i> 2024 DSOG Delivery System. 
                        <span style="color: var(--primary-green); font-weight: 600;">Location-Based Matching</span>
                    </p>
                    <p style="font-size: 0.8rem; margin-top: 0.5rem; color: var(--gray);">
                        Version 2.3.0 • WhatsApp Edition
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- User Registration Modal (Phone Number Collection) -->
    <div class="user-registration-modal" id="userRegistrationModal">
        <div class="registration-content">
            <div class="registration-header">
                <button class="registration-close" id="registrationClose">
                    <i class="fas fa-times"></i>
                </button>
                <div class="profile-avatar" id="registrationAvatar">
                    <!-- Avatar will be populated -->
                </div>
                <h3>Complete Your Registration</h3>
                <p style="color: rgba(255, 255, 255, 0.8); margin-top: 0.5rem;">Please provide your phone number for delivery notifications</p>
            </div>
            <div class="registration-body">
                <form class="registration-form" id="registrationForm" onsubmit="return false;">
                    <div class="form-group">
                        <label for="userPhone">Phone Number *</label>
                        <input type="tel" id="userPhone" class="form-control" placeholder="Enter your WhatsApp number (e.g., 254712345678)" required>
                        <small style="color: var(--text-secondary); font-size: 0.85rem;">This will be used for delivery notifications and WhatsApp communication</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="userLocation">Default Pickup Location *</label>
                        <input type="text" id="userLocation" class="form-control" placeholder="Enter your default pickup address" required>
                        <small style="color: var(--text-secondary); font-size: 0.85rem;">You can update this later in your profile</small>
                    </div>
                    
                    <div class="registration-actions">
                        <button type="submit" class="registration-btn registration-btn-primary" onclick="completeRegistration()">
                            <i class="fas fa-check"></i> Complete Registration
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- User Profile Modal -->
    <div class="user-profile-modal" id="userProfileModal">
        <div class="profile-content">
            <div class="profile-header">
                <button class="profile-close" id="profileClose">
                    <i class="fas fa-times"></i>
                </button>
                <div class="profile-avatar" id="profileAvatar">
                    <!-- Avatar will be populated -->
                </div>
                <h3 id="profileName">User Profile</h3>
            </div>
            <div class="profile-body">
                <div class="profile-info" id="profileInfo">
                    <!-- Profile info will be populated -->
                </div>
                <div class="profile-actions">
                    <button class="profile-btn profile-btn-primary" onclick="updateUserPhone()">
                        <i class="fas fa-phone"></i> Update Phone Number
                    </button>
                    <button class="profile-btn profile-btn-primary" onclick="updateUserLocation()">
                        <i class="fas fa-map-marker-alt"></i> Update Default Location
                    </button>
                    <button class="profile-btn sign-out-btn" onclick="signOut()">
                        <i class="fas fa-sign-out-alt"></i> Sign Out
                    </button>
                    <button class="profile-btn profile-btn-secondary" onclick="closeProfileModal()">
                        <i class="fas fa-times"></i> Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="confirmation-modal" id="confirmationModal">
        <div class="confirmation-content">
            <div class="confirmation-header">
                <h2><i class="fas fa-check-circle"></i> Confirm Pickup Request</h2>
                <button class="confirmation-close" id="confirmationClose">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="confirmation-body" id="confirmationBody">
                <!-- Confirmation details will be populated here -->
            </div>
        </div>
    </div>

    <!-- PWA Install Prompt -->
    <div class="pwa-install-prompt" id="pwaInstallPrompt">
        <button class="pwa-install-close" id="pwaInstallClose">
            <i class="fas fa-times"></i>
        </button>
        <div class="pwa-install-header">
            <div class="pwa-install-icon">
                <i class="fas fa-truck"></i>
            </div>
            <div>
                <div class="pwa-install-title">Install DSOG Delivery App</div>
                <div class="pwa-install-subtitle">WhatsApp-powered delivery management</div>
            </div>
        </div>
        <div class="pwa-install-buttons">
            <button class="pwa-install-btn pwa-install-secondary" id="pwaInstallLater">
                Maybe Later
            </button>
            <button class="pwa-install-btn pwa-install-primary" id="pwaInstallNow">
                Install Now
            </button>
        </div>
    </div>

    <!-- Content Overlay (shown when not signed in) -->
    <div class="content-overlay" id="contentOverlay">
        <div>
            <h2>Sign In Required</h2>
            <p>Please sign in with Google to access the delivery platform</p>
            <div id="overlayGoogleSignIn" class="gsi-container"></div>
        </div>
    </div>

    <!-- Enhanced Header -->
    <header>
        <div class="header-content">
            <img src="https://i.postimg.cc/kMZ1jTww/Untitled-design-4-removebg-preview.png" alt="DSOG Delivery" class="logo">
            
            <!-- User Profile -->
            <div class="user-profile-header" onclick="openProfileModal()" id="userProfileHeader">
                <div class="user-avatar" id="userAvatar">
                    <!-- Avatar will be populated -->
                </div>
                <span class="user-name" id="userNameDisplay">Guest</span>
            </div>
            
            <!-- Desktop Navigation -->
            <nav class="nav-links">
                <a href="#request" class="active">Request Pickup</a>
                <a href="#tracking">Track Delivery</a>
                <a href="#history">My Requests</a>
                <a href="#" class="install-app-btn" id="installAppBtn">
                    <i class="fas fa-download"></i>
                    <span>Install App</span>
                </a>
            </nav>
            
            <!-- Hamburger Menu Button -->
            <button class="hamburger" id="hamburgerBtn">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>
    </header>

    <!-- Mobile Menu -->
    <div class="mobile-menu" id="mobileMenu">
        <button class="close-menu" id="closeMenu">
            <i class="fas fa-times"></i>
        </button>
        <nav class="mobile-nav-links">
            <a href="#request" onclick="closeMobileMenu()">Request Pickup</a>
            <a href="#tracking" onclick="closeMobileMenu()">Track Delivery</a>
            <a href="#history" onclick="closeMobileMenu()">My Requests</a>
            <a href="#" onclick="openProfileModal(); closeMobileMenu();">
                <i class="fas fa-user"></i> My Profile
            </a>
            <a href="mailto:care.dsogstores@gmail.com" onclick="closeMobileMenu()">Email Support</a>
            <a href="https://wa.me/254733737983" onclick="closeMobileMenu()">WhatsApp Support</a>
            <a href="#" onclick="showInstallPrompt(); closeMobileMenu();" style="color: var(--primary-gold);">
                <i class="fas fa-download"></i> Install App
            </a>
        </nav>
    </div>
    
    <!-- Menu Backdrop -->
    <div class="menu-backdrop" id="menuBackdrop"></div>

    <!-- Main Content -->
    <main id="mainContent">
        <!-- Step Progress Indicator -->
        <div class="step-progress" id="stepProgress">
            <div class="step-progress-bar" id="stepProgressBar"></div>
            <div class="step active" data-step="1" onclick="goToStep(1)">
                <div class="step-circle">1</div>
                <div class="step-label">Location</div>
            </div>
            <div class="step" data-step="2" onclick="goToStep(2)">
                <div class="step-circle">2</div>
                <div class="step-label">Package Details</div>
            </div>
            <div class="step" data-step="3" onclick="goToStep(3)">
                <div class="step-circle">3</div>
                <div class="step-label">Assistant</div>
            </div>
            <div class="step" data-step="4" onclick="goToStep(4)">
                <div class="step-circle">4</div>
                <div class="step-label">Review</div>
            </div>
        </div>

        <!-- Step 1: Location -->
        <div class="step-content active" id="step1">
            <div class="location-card">
                <div class="location-card-header">
                    <i class="fas fa-map-marker-alt"></i>
                    <h3>Enter Your Location</h3>
                </div>
                <p style="margin-bottom: 1.5rem; color: var(--text-secondary);">
                    <strong>IMPORTANT:</strong> Enter your exact pickup location to find assistants available in your area.
                </p>
                
                <div class="location-input-group">
                    <input type="text" id="manualLocationInput" class="location-input" 
                           placeholder="Enter your exact pickup location (e.g., Nairobi CBD, Westlands Mall, etc.)">
                    <button class="location-btn" onclick="useManualLocation()">
                        <i class="fas fa-check"></i> Set Location
                    </button>
                </div>
                
                <div style="background: linear-gradient(135deg, rgba(212, 175, 55, 0.1), rgba(37, 211, 102, 0.1)); padding: 1rem; border-radius: 8px; margin-top: 1rem; border-left: 4px solid var(--primary-gold);">
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                        <i class="fas fa-info-circle" style="color: var(--primary-gold);"></i>
                        <strong style="color: var(--text-primary);">How it works:</strong>
                    </div>
                    <ul style="color: var(--text-secondary); font-size: 0.9rem; padding-left: 1.5rem;">
                        <li>Enter your exact pickup location</li>
                        <li>We'll show only assistants available in your area</li>
                        <li>Assistants are filtered by their operational zones</li>
                        <li>No location = No assistants will be shown</li>
                    </ul>
                </div>
                
                <div class="current-location-display" id="currentLocationDisplay">
                    <div class="location-status">
                        <i class="fas fa-check-circle"></i>
                        <strong>Current Location:</strong>
                    </div>
                    <p id="currentLocationText" style="margin: 0.5rem 0; font-size: 1.1rem; font-weight: 600;">No location set</p>
                    <small style="color: var(--text-secondary);">
                        <i class="fas fa-info-circle"></i> Only assistants in your area will be shown.
                    </small>
                </div>
            </div>

            <!-- Enhanced Charge Calculator -->
            <div class="charge-calculator-card" id="chargeCalculator">
                <div class="calculator-header">
                    <i class="fas fa-calculator"></i>
                    <h3>Delivery Charge Calculator</h3>
                </div>
                <p style="margin-bottom: 1.5rem; color: var(--text-secondary);">
                    Enter delivery details to calculate estimated charges. Charges are automatically calculated based on package size and distance.
                </p>
                
                <div class="calculator-grid">
                    <div class="calculator-input-group">
                        <label class="calculator-label">
                            <i class="fas fa-road"></i> Delivery Distance *
                        </label>
                        <select id="deliveryDistance" class="calculator-input calculator-input select" required onchange="calculateCharges()">
                            <option value="">Select distance zone</option>
                            <option value="same">Same Region/Zone (0-5km)</option>
                            <option value="nearby">Nearby Region (5-10km)</option>
                            <option value="far">Far Region (10-20km)</option>
                            <option value="distant">Distant Region (20+ km)</option>
                        </select>
                    </div>
                    
                    <div class="calculator-input-group">
                        <label class="calculator-label">
                            <i class="fas fa-weight-hanging"></i> Package Weight (kg) *
                        </label>
                        <input type="number" id="packageWeight" class="calculator-input" min="0" max="30" step="0.1" 
                               placeholder="Enter weight in kg" oninput="calculateCharges()">
                    </div>
                </div>
                
                <div class="calculator-result" id="calculatorResult" style="display: none;">
                    <div class="result-header">
                        <i class="fas fa-receipt"></i>
                        <h4>Calculated Charges</h4>
                    </div>
                    
                    <div class="charge-breakdown">
                        <div class="charge-item">
                            <div class="charge-label">Base Charge</div>
                            <div class="charge-value" id="baseCharge">Ksh 0</div>
                        </div>
                        <div class="charge-item">
                            <div class="charge-label">Distance Surcharge</div>
                            <div class="charge-value" id="distanceSurcharge">Ksh 0</div>
                        </div>
                        <div class="charge-item">
                            <div class="charge-label">Weight Surcharge</div>
                            <div class="charge-value" id="weightSurcharge">Ksh 0</div>
                        </div>
                        <div class="charge-item charge-total">
                            <div class="charge-label">Total Charge</div>
                            <div class="charge-value" id="totalCharge">Ksh 0</div>
                        </div>
                    </div>
                    
                    <p class="charge-note">
                        <i class="fas fa-info-circle"></i> 
                        Charges are estimates. Final amount may vary based on actual package dimensions.
                    </p>
                </div>
            </div>
            
            <div class="step-navigation">
                <button class="step-btn prev" disabled>
                    <i class="fas fa-arrow-left"></i> Previous
                </button>
                <button class="step-btn next" onclick="nextStep()" id="step1NextBtn" disabled>
                    Next <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>

        <!-- Step 2: Package Details -->
        <div class="step-content" id="step2">
            <div class="package-selection-card">
                <div class="package-selection-header">
                    <i class="fas fa-box-open"></i>
                    <h3>Select Package Type</h3>
                </div>
                <p style="margin-bottom: 1.5rem; color: var(--text-secondary);">
                    Choose the package type that best matches your delivery needs. Base charges vary by size and handling requirements.
                </p>
                
                <div class="package-grid" id="packageTypeSelection">
                    <div class="package-card" data-type="small" data-size="Small (0-5kg)" data-price="200">
                        <div class="package-icon">
                            <i class="fas fa-box"></i>
                        </div>
                        <div class="package-name">Small Package</div>
                        <div class="package-size">0-5 kg</div>
                        <div class="package-price">From Ksh 200</div>
                    </div>
                    <div class="package-card" data-type="medium" data-size="Medium (5-15kg)" data-price="290">
                        <div class="package-icon">
                            <i class="fas fa-box-open"></i>
                        </div>
                        <div class="package-name">Medium Package</div>
                        <div class="package-size">5-15 kg</div>
                        <div class="package-price">From Ksh 290</div>
                    </div>
                    <div class="package-card" data-type="large" data-size="Large (15-30kg)" data-price="380">
                        <div class="package-icon">
                            <i class="fas fa-pallet"></i>
                        </div>
                        <div class="package-name">Large Package</div>
                        <div class="package-size">15-30 kg</div>
                        <div class="package-price">From Ksh 380</div>
                    </div>
                    <div class="package-card" data-type="fragile" data-size="Fragile (Special)" data-price="250">
                        <div class="package-icon">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="package-name">Fragile Items</div>
                        <div class="package-size">Special handling</div>
                        <div class="package-price">From Ksh 250</div>
                    </div>
                </div>
                <input type="hidden" id="packageType" required>
                <input type="hidden" id="packageSize" required>
            </div>
            
            <div class="form-card">
                <div class="form-card-header">
                    <i class="fas fa-edit"></i>
                    <h3>Delivery Details</h3>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-user"></i> Your Name *
                        </label>
                        <input type="text" id="customerName" class="form-control" placeholder="Enter your full name" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-phone"></i> Phone Number *
                        </label>
                        <input type="tel" id="customerPhone" class="form-control" placeholder="Enter your phone number" required>
                    </div>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-map-pin"></i> Pickup Location *
                        </label>
                        <input type="text" id="pickupLocation" class="form-control" 
                               placeholder="Enter pickup address" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-map-marker-alt"></i> Delivery Destination *
                        </label>
                        <input type="text" id="deliveryLocation" class="form-control" placeholder="Enter delivery address" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-clipboard-list"></i> Item Description *
                    </label>
                    <textarea id="itemDescription" class="form-control form-textarea" 
                              placeholder="Describe the items in the package (e.g., Clothing, Electronics, Documents, etc.)" required></textarea>
                    <div class="char-count" id="charCount">0/200</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-sticky-note"></i> Special Instructions (Optional)
                    </label>
                    <textarea id="specialInstructions" class="form-control form-textarea" 
                              placeholder="Any special handling requirements or delivery instructions"></textarea>
                </div>
            </div>
            
            <div class="step-navigation">
                <button class="step-btn prev" onclick="prevStep()">
                    <i class="fas fa-arrow-left"></i> Previous
                </button>
                <button class="step-btn next" onclick="nextStep()" id="step2NextBtn" disabled>
                    Next <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>

        <!-- Step 3: Assistant Selection -->
        <div class="step-content" id="step3">
            <div class="assistant-selection-card">
                <div class="assistant-header">
                    <h3>Available Delivery Assistants</h3>
                    <div class="assistant-sorting">
                        <button class="sort-btn active" onclick="filterAssistants('all')" id="sortAll">
                            <i class="fas fa-list"></i> All in Your Area
                        </button>
                        <button class="sort-btn" onclick="filterAssistants('rating')" id="sortRating">
                            <i class="fas fa-star"></i> Top Rated
                        </button>
                        <button class="sort-btn" onclick="filterAssistants('distance')" id="sortDistance">
                            <i class="fas fa-bolt"></i> Fastest
                        </button>
                    </div>
                </div>
                
                <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                    <i class="fas fa-info-circle"></i> 
                    <span id="assistantCount">Loading assistants...</span>
                    <span id="locationFilterStatus" style="display: none; color: var(--primary-green); margin-left: 1rem;">
                        • Filtered by your location
                    </span>
                </p>
                
                <div id="locationWarning" style="display: none; background: linear-gradient(135deg, rgba(212, 175, 55, 0.1), rgba(212, 175, 55, 0.05)); padding: 1rem; border-radius: 8px; border-left: 4px solid var(--warning); margin-bottom: 1.5rem;">
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                        <i class="fas fa-exclamation-triangle" style="color: var(--warning);"></i>
                        <strong style="color: var(--text-primary);">No location set</strong>
                    </div>
                    <p style="color: var(--text-secondary); font-size: 0.9rem; margin: 0;">
                        Please go back to Step 1 and set your pickup location to see available assistants in your area.
                    </p>
                </div>
                
                <div class="loading" id="assistantsLoading">
                    <div class="loading-spinner"></div>
                    <p>Loading delivery assistants in your area...</p>
                </div>
                
                <div class="assistants-grid" id="assistantsGrid">
                    <!-- Assistants will be loaded here -->
                </div>
                
                <div class="no-assistants" id="noAssistants" style="display: none;">
                    <i class="fas fa-users-slash"></i>
                    <h4>No Assistants Available in Your Area</h4>
                    <p>There are currently no delivery assistants available in your location.</p>
                    <p style="font-size: 0.9rem; color: var(--text-secondary); margin-top: 0.5rem;">
                        <i class="fas fa-lightbulb"></i> Try entering a different location or check back later.
                    </p>
                    <button class="step-btn next" onclick="loadDeliveryAssistants()" style="margin-top: 1rem; width: auto;">
                        <i class="fas fa-sync-alt"></i> Refresh Assistants
                    </button>
                </div>
            </div>
            
            <div class="step-navigation">
                <button class="step-btn prev" onclick="prevStep()">
                    <i class="fas fa-arrow-left"></i> Previous
                </button>
                <button class="step-btn next" onclick="nextStep()" id="step3NextBtn" disabled>
                    Next <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>

        <!-- Step 4: Review -->
        <div class="step-content" id="step4">
            <div class="review-card">
                <div class="review-header">
                    <i class="fas fa-clipboard-check"></i>
                    <h3>Review Your Order</h3>
                </div>
                
                <div class="review-grid">
                    <div class="review-item">
                        <div class="review-label">Pickup Location</div>
                        <div class="review-value" id="reviewPickupLocation">Not set</div>
                    </div>
                    <div class="review-item">
                        <div class="review-label">Delivery Destination</div>
                        <div class="review-value" id="reviewDeliveryLocation">Not set</div>
                    </div>
                    <div class="review-item">
                        <div class="review-label">Package Type</div>
                        <div class="review-value" id="reviewPackageType">Not selected</div>
                    </div>
                    <div class="review-item">
                        <div class="review-label">Selected Assistant</div>
                        <div class="review-value" id="reviewAssistant">Not selected</div>
                    </div>
                </div>
                
                <div class="review-charges">
                    <h4><i class="fas fa-money-bill-wave"></i> Delivery Charges</h4>
                    <div class="review-grid">
                        <div class="review-item">
                            <div class="review-label">Base Charge</div>
                            <div class="review-value" id="reviewBaseCharge">Ksh 0</div>
                        </div>
                        <div class="review-item">
                            <div class="review-label">Distance Surcharge</div>
                            <div class="review-value" id="reviewDistanceSurcharge">Ksh 0</div>
                        </div>
                        <div class="review-item">
                            <div class="review-label">Weight Surcharge</div>
                            <div class="review-value" id="reviewWeightSurcharge">Ksh 0</div>
                        </div>
                        <div class="review-item" style="background: var(--primary-green); color: var(--white);">
                            <div class="review-label">Total Charge</div>
                            <div class="review-value" id="reviewTotalCharge">Ksh 0</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <button class="step-btn confirm" onclick="confirmPickupRequest()" id="finalConfirmBtn">
                <i class="fab fa-whatsapp"></i> Confirm & Send via WhatsApp
            </button>
            
            <div class="step-navigation">
                <button class="step-btn prev" onclick="prevStep()">
                    <i class="fas fa-arrow-left"></i> Previous
                </button>
                <button class="step-btn next" style="visibility: hidden;">
                    Next <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>
    </main>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <div class="bottom-nav-container">
            <button class="nav-item active" onclick="goToStep(1)">
                <i class="fas fa-map-marker-alt nav-icon"></i>
                <span class="nav-label">Location</span>
            </button>
            <button class="nav-item" onclick="goToStep(2)">
                <i class="fas fa-box-open nav-icon"></i>
                <span class="nav-label">Package</span>
            </button>
            <button class="nav-item" onclick="goToStep(3)">
                <i class="fas fa-user-tie nav-icon"></i>
                <span class="nav-label">Assistant</span>
            </button>
            <button class="nav-item" onclick="goToStep(4)">
                <i class="fas fa-check-circle nav-icon"></i>
                <span class="nav-label">Review</span>
            </button>
            <button class="nav-item" onclick="openProfileModal()">
                <i class="fas fa-user nav-icon"></i>
                <span class="nav-label">Profile</span>
            </button>
        </div>
    </nav>

    <!-- JavaScript -->
    <script>
        // Configuration
        const scriptUrl = 'https://script.google.com/macros/s/AKfycbzmBoCu_jXpp8oKpNAnX7Ly-bqvfdfhgiHge74ZW0Yae0wUlZERDERJYB-ZC76J9kQYQ/exec';
        const SUPPORT_WHATSAPP = '254733737983';
        const GOOGLE_CLIENT_ID = '369304497158-8ub6b68v2bjvsfciome6q56flh2rd1m4.apps.googleusercontent.com';
        
        // Pricing Configuration
        const pricingConfig = {
            baseCharges: {
                small: 200,    // 0-5kg
                medium: 290,   // 5-15kg (+90 from small)
                large: 380,    // 15-30kg (+90 from medium)
                fragile: 250   // Special handling
            },
            distanceMultipliers: {
                same: 0.0,     // Same region/zone (0-5km): +0%
                nearby: 0.2,   // Nearby region (5-10km): +20%
                far: 0.4,      // Far region (10-20km): +40%
                distant: 0.6   // Distant region (20+km): +60%
            },
            weightSurcharges: {
                over15kg: 50,  // Additional charge for >15kg
                over20kg: 100  // Additional charge for >20kg
            }
        };
        
        // State management
        let userProfile = JSON.parse(localStorage.getItem('dsog_delivery_profile')) || null;
        let googleUser = null;
        let googleToken = null;
        let selectedPackageType = null;
        let selectedPackageSize = null;
        let selectedAssistant = null;
        let userLocation = null;
        let deliveryAssistants = [];
        let userDeliveryHistory = [];
        let currentFilterMode = 'all';
        let currentCharges = {
            baseCharge: 0,
            distanceSurcharge: 0,
            weightSurcharge: 0,
            totalCharge: 0,
            packageType: '',
            distanceZone: '',
            weight: 0
        };
        let currentStep = 1;
        
        // PWA variables
        let deferredPrompt = null;
        let isAppInstalled = false;
        let isInstallPromptShown = false;
        
        // Location to zone mapping
        const locationZoneMapping = {
            // Nairobi Zones
            'nairobi cbd': ['Central', 'Nairobi CBD'],
            'westlands': ['West', 'Westlands'],
            'parklands': ['West', 'Parklands'],
            'lavington': ['West', 'Lavington'],
            'kilimani': ['Central', 'Kilimani'],
            'karen': ['South West', 'Karen'],
            'langata': ['South West', 'Langata'],
            'rongai': ['South West', 'Rongai'],
            'industrial area': ['South', 'Industrial Area'],
            'south b': ['South', 'South B'],
            'south c': ['South', 'South C'],
            'eastleigh': ['North East', 'Eastleigh'],
            'pangani': ['North East', 'Pangani'],
            'huruma': ['North East', 'Huruma'],
            'kasarani': ['North', 'Kasarani'],
            'ruaka': ['West', 'Ruaka'],
            'ruiru': ['East', 'Ruiru'],
            'thika': ['East', 'Thika'],
            'juja': ['East', 'Juja'],
            
            // Common variations
            'cbd': ['Central', 'Nairobi CBD'],
            'industrial': ['South', 'Industrial Area'],
            'west lands': ['West', 'Westlands'],
            
            // General areas
            'central': ['Central', 'Central Nairobi'],
            'west': ['West', 'West Nairobi'],
            'south': ['South', 'South Nairobi'],
            'east': ['East', 'East Nairobi'],
            'north': ['North', 'North Nairobi']
        };
        
        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 DSOG Delivery Platform v2.3.0 - Location-Based Assistant Filtering');
            
            // Start preloader
            startPreloader();
            
            // Initialize components after preloader
            setTimeout(() => {
                initMobileMenu();
                initPackageTypeSelection();
                initCharCounter();
                initConfirmationModal();
                initPWA();
                initProfileModal();
                initRegistrationModal();
                initLocationInput();
                initStepNavigation();
                
                // Check for existing Google Sign-in
                if (checkGoogleSignIn()) {
                    hidePreloader();
                    showMainContent();
                } else {
                    hidePreloader();
                    setTimeout(() => {
                        showGoogleSignInModal();
                    }, 500);
                }
                
                // Initialize Google Sign-in
                setTimeout(initializeGoogleSignIn, 1000);
            }, 2500);
        });
        
        // Preloader Functions
        function startPreloader() {
            const preloader = document.getElementById('preloader');
            const progressFill = document.getElementById('progressFill');
            const progressPercent = document.getElementById('progressPercent');
            const steps = [
                document.getElementById('step1Loading'),
                document.getElementById('step2Loading'),
                document.getElementById('step3Loading'),
                document.getElementById('step4Loading')
            ];
            
            let progress = 0;
            const interval = setInterval(() => {
                progress += 1;
                if (progress <= 100) {
                    progressFill.style.width = progress + '%';
                    progressPercent.textContent = progress + '%';
                    
                    // Update steps based on progress
                    if (progress >= 25 && progress < 25) {
                        steps[0].classList.add('active');
                    } else if (progress >= 25 && progress < 50) {
                        steps[0].classList.remove('active');
                        steps[0].classList.add('completed');
                        steps[1].classList.add('active');
                    } else if (progress >= 50 && progress < 75) {
                        steps[1].classList.remove('active');
                        steps[1].classList.add('completed');
                        steps[2].classList.add('active');
                    } else if (progress >= 75 && progress < 100) {
                        steps[2].classList.remove('active');
                        steps[2].classList.add('completed');
                        steps[3].classList.add('active');
                    } else if (progress >= 100) {
                        steps[3].classList.remove('active');
                        steps[3].classList.add('completed');
                        clearInterval(interval);
                    }
                }
            }, 25); // Faster loading for better UX
        }
        
        function hidePreloader() {
            const preloader = document.getElementById('preloader');
            setTimeout(() => {
                preloader.classList.add('hidden');
            }, 500);
        }
        
        // Initialize Step Navigation
        function initStepNavigation() {
            // Initialize step 1 validation
            const manualLocationInput = document.getElementById('manualLocationInput');
            const deliveryDistance = document.getElementById('deliveryDistance');
            const packageWeight = document.getElementById('packageWeight');
            const step1NextBtn = document.getElementById('step1NextBtn');
            
            function validateStep1() {
                const hasLocation = userLocation && userLocation.address;
                const hasDistance = deliveryDistance && deliveryDistance.value;
                const hasWeight = packageWeight && packageWeight.value && parseFloat(packageWeight.value) > 0;
                step1NextBtn.disabled = !(hasLocation && hasDistance && hasWeight);
                return hasLocation && hasDistance && hasWeight;
            }
            
            if (manualLocationInput) {
                manualLocationInput.addEventListener('input', validateStep1);
            }
            if (deliveryDistance) {
                deliveryDistance.addEventListener('change', validateStep1);
            }
            if (packageWeight) {
                packageWeight.addEventListener('input', validateStep1);
            }
            
            // Initialize step 2 validation
            const customerName = document.getElementById('customerName');
            const customerPhone = document.getElementById('customerPhone');
            const pickupLocation = document.getElementById('pickupLocation');
            const deliveryLocation = document.getElementById('deliveryLocation');
            const itemDescription = document.getElementById('itemDescription');
            const step2NextBtn = document.getElementById('step2NextBtn');
            
            function validateStep2() {
                const hasName = customerName && customerName.value.trim();
                const hasPhone = customerPhone && customerPhone.value.trim();
                const hasPickup = pickupLocation && pickupLocation.value.trim();
                const hasDelivery = deliveryLocation && deliveryLocation.value.trim();
                const hasDescription = itemDescription && itemDescription.value.trim();
                const hasPackageType = selectedPackageType;
                step2NextBtn.disabled = !(hasName && hasPhone && hasPickup && hasDelivery && hasDescription && hasPackageType);
                return hasName && hasPhone && hasPickup && hasDelivery && hasDescription && hasPackageType;
            }
            
            if (customerName) customerName.addEventListener('input', validateStep2);
            if (customerPhone) customerPhone.addEventListener('input', validateStep2);
            if (pickupLocation) pickupLocation.addEventListener('input', validateStep2);
            if (deliveryLocation) deliveryLocation.addEventListener('input', validateStep2);
            if (itemDescription) itemDescription.addEventListener('input', validateStep2);
            
            // Initialize step 3 validation
            const step3NextBtn = document.getElementById('step3NextBtn');
            
            function validateStep3() {
                step3NextBtn.disabled = !selectedAssistant;
                return !!selectedAssistant;
            }
            
            // Auto-validate when assistant is selected
            window.validateStep3 = validateStep3;
        }
        
        // Step Navigation Functions
        function goToStep(stepNumber) {
            if (stepNumber < 1 || stepNumber > 4) return;
            
            // Validate current step before moving
            if (stepNumber > currentStep) {
                if (!validateStep(currentStep)) {
                    showNotification('Please complete all required fields in this step', 'error');
                    return;
                }
            }
            
            currentStep = stepNumber;
            updateStepProgress();
            
            // Hide all step contents
            document.querySelectorAll('.step-content').forEach(step => {
                step.classList.remove('active');
            });
            
            // Show current step content
            const currentStepContent = document.getElementById('step' + stepNumber);
            if (currentStepContent) {
                currentStepContent.classList.add('active');
                
                // Load assistants when step 3 is active
                if (stepNumber === 3) {
                    if (!userLocation || !userLocation.address) {
                        showLocationWarning();
                    } else {
                        loadDeliveryAssistants();
                    }
                }
                
                // Update review when step 4 is active
                if (stepNumber === 4) {
                    updateReviewStep();
                }
            }
            
            // Update bottom nav
            updateBottomNav(stepNumber);
            
            // Scroll to top of step
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        function nextStep() {
            if (currentStep < 4) {
                goToStep(currentStep + 1);
            }
        }
        
        function prevStep() {
            if (currentStep > 1) {
                goToStep(currentStep - 1);
            }
        }
        
        function validateStep(stepNumber) {
            switch(stepNumber) {
                case 1:
                    return validateStep1();
                case 2:
                    return validateStep2();
                case 3:
                    return validateStep3();
                default:
                    return true;
            }
        }
        
        function updateStepProgress() {
            // Update step circles
            document.querySelectorAll('.step').forEach((step, index) => {
                const stepNumber = index + 1;
                step.classList.remove('active', 'completed');
                
                if (stepNumber === currentStep) {
                    step.classList.add('active');
                } else if (stepNumber < currentStep) {
                    step.classList.add('completed');
                }
            });
            
            // Update progress bar
            const progressPercentage = ((currentStep - 1) / 3) * 100;
            const progressBar = document.getElementById('stepProgressBar');
            if (progressBar) {
                progressBar.style.width = progressPercentage + '%';
            }
        }
        
        function updateBottomNav(stepNumber) {
            document.querySelectorAll('.bottom-nav .nav-item').forEach((item, index) => {
                item.classList.remove('active');
                if (index === stepNumber - 1) {
                    item.classList.add('active');
                }
            });
        }
        
        // Initialize location input with autocomplete
        function initLocationInput() {
            const locationInput = document.getElementById('manualLocationInput');
            const pickupLocationInput = document.getElementById('pickupLocation');
            
            // Set up autocomplete if Google Maps API is available
            if (typeof google !== 'undefined' && google.maps && google.maps.places) {
                try {
                    const autocomplete = new google.maps.places.Autocomplete(locationInput, {
                        types: ['geocode', 'establishment'],
                        componentRestrictions: {country: 'ke'}
                    });
                    
                    autocomplete.addListener('place_changed', function() {
                        const place = autocomplete.getPlace();
                        if (place && place.formatted_address) {
                            pickupLocationInput.value = place.formatted_address;
                        }
                    });
                } catch (error) {
                    console.log('Google Places autocomplete not available:', error);
                }
            }
            
            // Auto-fill pickup location when manual location is entered
            locationInput.addEventListener('input', function() {
                if (this.value.trim() && !pickupLocationInput.value) {
                    pickupLocationInput.value = this.value;
                }
            });
        }
        
        // Calculate Delivery Charges
        function calculateCharges() {
            const packageType = selectedPackageType || document.getElementById('packageType').value;
            const distanceZone = document.getElementById('deliveryDistance').value;
            const weightInput = document.getElementById('packageWeight');
            const weight = parseFloat(weightInput.value) || 0;
            
            const calculatorResult = document.getElementById('calculatorResult');
            
            // Hide calculator result if no distance selected
            if (!distanceZone) {
                if (calculatorResult) calculatorResult.style.display = 'none';
                return;
            }
            
            // Use small package as default for calculation if none selected
            const effectivePackageType = packageType || 'small';
            let baseCharge = pricingConfig.baseCharges[effectivePackageType] || 0;
            
            // Calculate distance surcharge
            const distanceMultiplier = pricingConfig.distanceMultipliers[distanceZone] || 0;
            const distanceSurcharge = Math.round(baseCharge * distanceMultiplier);
            
            // Calculate weight surcharge
            let weightSurcharge = 0;
            if (weight > 20) {
                weightSurcharge = pricingConfig.weightSurcharges.over20kg;
            } else if (weight > 15) {
                weightSurcharge = pricingConfig.weightSurcharges.over15kg;
            }
            
            // Calculate total
            const totalCharge = baseCharge + distanceSurcharge + weightSurcharge;
            
            // Update charge display
            document.getElementById('baseCharge').textContent = `Ksh ${baseCharge}`;
            document.getElementById('distanceSurcharge').textContent = `Ksh ${distanceSurcharge}`;
            document.getElementById('weightSurcharge').textContent = `Ksh ${weightSurcharge}`;
            document.getElementById('totalCharge').textContent = `Ksh ${totalCharge}`;
            
            // Show calculator result
            if (calculatorResult) {
                calculatorResult.style.display = 'block';
            }
            
            // Update current charges state
            currentCharges = {
                baseCharge,
                distanceSurcharge,
                weightSurcharge,
                totalCharge,
                packageType: effectivePackageType,
                distanceZone,
                weight
            };
            
            // Validate step 1
            validateStep1();
        }
        
        // Manual Location Functions
        function useManualLocation() {
            const manualInput = document.getElementById('manualLocationInput');
            const locationText = document.getElementById('currentLocationText');
            const pickupField = document.getElementById('pickupLocation');
            const locationDisplay = document.getElementById('currentLocationDisplay');
            
            if (!manualInput || !locationText || !pickupField || !locationDisplay) return;
            
            const manualLocation = manualInput.value.trim();
            
            if (!manualLocation) {
                showNotification('Please enter a location', 'error');
                return;
            }
            
            locationText.textContent = manualLocation;
            pickupField.value = manualLocation;
            userLocation = { 
                manual: true, 
                address: manualLocation,
                zone: getZoneFromLocation(manualLocation)
            };
            
            // Show location display
            locationDisplay.classList.add('active');
            
            // Update location filter status
            const locationFilterStatus = document.getElementById('locationFilterStatus');
            if (locationFilterStatus) {
                locationFilterStatus.style.display = 'inline';
            }
            
            // Validate step 1
            validateStep1();
            
            showNotification('Location set successfully! Only assistants in your area will be shown.');
            
            // If we're on step 3, reload assistants
            if (currentStep === 3) {
                hideLocationWarning();
                loadDeliveryAssistants();
            }
        }
        
        function getZoneFromLocation(location) {
            const locationLower = location.toLowerCase().trim();
            
            // Check for exact matches
            for (const [key, zones] of Object.entries(locationZoneMapping)) {
                if (locationLower.includes(key)) {
                    return zones[0]; // Return primary zone
                }
            }
            
            // Check for partial matches
            for (const [key, zones] of Object.entries(locationZoneMapping)) {
                const keyParts = key.split(' ');
                let matchCount = 0;
                for (const part of keyParts) {
                    if (locationLower.includes(part)) {
                        matchCount++;
                    }
                }
                if (matchCount >= keyParts.length / 2) {
                    return zones[0];
                }
            }
            
            // Default to Central if no match found
            return 'Central';
        }
        
        function showLocationWarning() {
            const warning = document.getElementById('locationWarning');
            const assistantsLoading = document.getElementById('assistantsLoading');
            const assistantsGrid = document.getElementById('assistantsGrid');
            const noAssistants = document.getElementById('noAssistants');
            
            if (warning) warning.style.display = 'block';
            if (assistantsLoading) assistantsLoading.classList.remove('visible');
            if (assistantsGrid) assistantsGrid.innerHTML = '';
            if (noAssistants) noAssistants.style.display = 'none';
            
            // Update assistant count
            const assistantCount = document.getElementById('assistantCount');
            if (assistantCount) {
                assistantCount.textContent = 'Set location to see assistants';
            }
        }
        
        function hideLocationWarning() {
            const warning = document.getElementById('locationWarning');
            if (warning) warning.style.display = 'none';
        }
        
        // Initialize Package Type Selection
        function initPackageTypeSelection() {
            const packageCards = document.querySelectorAll('.package-card');
            const packageTypeInput = document.getElementById('packageType');
            const packageSizeInput = document.getElementById('packageSize');
            
            packageCards.forEach(card => {
                card.addEventListener('click', function() {
                    packageCards.forEach(c => c.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedPackageType = this.dataset.type;
                    selectedPackageSize = this.dataset.size;
                    if (packageTypeInput) packageTypeInput.value = selectedPackageType;
                    if (packageSizeInput) packageSizeInput.value = selectedPackageSize;
                    
                    // Trigger charge calculation if distance and weight are set
                    const distanceZone = document.getElementById('deliveryDistance').value;
                    const weight = document.getElementById('packageWeight').value;
                    if (distanceZone && weight) {
                        calculateCharges();
                    }
                    
                    // Validate step 2
                    validateStep2();
                });
            });
        }
        
        // Initialize Character Counter
        function initCharCounter() {
            const textarea = document.getElementById('itemDescription');
            const charCount = document.getElementById('charCount');
            
            if (!textarea || !charCount) return;
            
            textarea.addEventListener('input', function() {
                const length = this.value.length;
                charCount.textContent = `${length}/200`;
                
                if (length > 200) {
                    charCount.style.color = 'var(--error)';
                } else if (length > 150) {
                    charCount.style.color = 'var(--warning)';
                } else {
                    charCount.style.color = 'var(--gray)';
                }
                
                // Validate step 2
                validateStep2();
            });
        }
        
        // Update Review Step
        function updateReviewStep() {
            // Update location
            const reviewPickupLocation = document.getElementById('reviewPickupLocation');
            const pickupLocation = document.getElementById('pickupLocation');
            if (reviewPickupLocation && pickupLocation) {
                reviewPickupLocation.textContent = pickupLocation.value || 'Not set';
            }
            
            // Update delivery
            const reviewDeliveryLocation = document.getElementById('reviewDeliveryLocation');
            const deliveryLocation = document.getElementById('deliveryLocation');
            if (reviewDeliveryLocation && deliveryLocation) {
                reviewDeliveryLocation.textContent = deliveryLocation.value || 'Not set';
            }
            
            // Update package
            const reviewPackageType = document.getElementById('reviewPackageType');
            if (reviewPackageType && selectedPackageType) {
                const packageName = selectedPackageType.charAt(0).toUpperCase() + selectedPackageType.slice(1);
                reviewPackageType.textContent = `${packageName} (${selectedPackageSize})`;
            }
            
            // Update assistant
            const reviewAssistant = document.getElementById('reviewAssistant');
            if (reviewAssistant && selectedAssistant) {
                reviewAssistant.textContent = `${selectedAssistant.name} (${selectedAssistant.phone})`;
            }
            
            // Update charges
            const reviewBaseCharge = document.getElementById('reviewBaseCharge');
            const reviewDistanceSurcharge = document.getElementById('reviewDistanceSurcharge');
            const reviewWeightSurcharge = document.getElementById('reviewWeightSurcharge');
            const reviewTotalCharge = document.getElementById('reviewTotalCharge');
            
            if (reviewBaseCharge) reviewBaseCharge.textContent = `Ksh ${currentCharges.baseCharge}`;
            if (reviewDistanceSurcharge) reviewDistanceSurcharge.textContent = `Ksh ${currentCharges.distanceSurcharge}`;
            if (reviewWeightSurcharge) reviewWeightSurcharge.textContent = `Ksh ${currentCharges.weightSurcharge}`;
            if (reviewTotalCharge) reviewTotalCharge.textContent = `Ksh ${currentCharges.totalCharge}`;
            
            // Enable/disable final confirm button
            const finalConfirmBtn = document.getElementById('finalConfirmBtn');
            if (finalConfirmBtn) {
                finalConfirmBtn.disabled = !validateStep2() || !validateStep3();
            }
        }
        
        // Google Sign-in Functions
        function initializeGoogleSignIn() {
            if (typeof google === 'undefined') {
                console.log('Google Sign-in SDK not loaded yet, retrying...');
                setTimeout(initializeGoogleSignIn, 1000);
                return;
            }
            
            try {
                google.accounts.id.initialize({
                    client_id: GOOGLE_CLIENT_ID,
                    callback: handleGoogleSignIn,
                    auto_select: false,
                    cancel_on_tap_outside: true,
                    context: 'signin',
                    ux_mode: 'popup',
                    login_uri: window.location.origin,
                    prompt_parent_id: 'googleSignInButton'
                });
                
                // Render Google Sign-in button if element exists
                const googleSignInButton = document.getElementById('googleSignInButton');
                if (googleSignInButton) {
                    google.accounts.id.renderButton(
                        googleSignInButton,
                        {
                            type: 'standard',
                            theme: 'filled_blue',
                            size: 'large',
                            text: 'signin_with',
                            shape: 'rectangular',
                            logo_alignment: 'left',
                            width: 250
                        }
                    );
                }
                
                // Render overlay Google Sign-in button if element exists
                const overlayGoogleSignIn = document.getElementById('overlayGoogleSignIn');
                if (overlayGoogleSignIn) {
                    google.accounts.id.renderButton(
                        overlayGoogleSignIn,
                        {
                            type: 'standard',
                            theme: 'filled_blue',
                            size: 'large',
                            text: 'signin_with',
                            shape: 'rectangular',
                            logo_alignment: 'left',
                            width: 250
                        }
                    );
                }
                
                console.log('✅ Google Sign-in initialized successfully');
            } catch (error) {
                console.error('Error initializing Google Sign-in:', error);
            }
        }
        
        function triggerGoogleSignIn() {
            const googleButton = document.querySelector('#googleSignInButton div[role="button"]');
            if (googleButton) {
                googleButton.click();
            } else {
                console.error('Google Sign-in button not found');
                showNotification('Unable to initiate Google Sign-in. Please refresh the page.', 'error');
            }
        }
        
        function checkGoogleSignIn() {
            if (userProfile && userProfile.googleId) {
                updateUserProfileUI();
                autoFillRequestForm();
                setupNavigation();
                loadUserDeliveryHistory();
                return true;
            }
            return false;
        }
        
        function handleGoogleSignIn(response) {
            console.log('Google Sign-in response received');
            
            const responsePayload = decodeJWTResponse(response.credential);
            
            if (responsePayload) {
                googleUser = responsePayload;
                googleToken = response.credential;
                
                userProfile = {
                    googleId: googleUser.sub,
                    email: googleUser.email,
                    name: googleUser.name,
                    givenName: googleUser.given_name,
                    familyName: googleUser.family_name,
                    picture: googleUser.picture,
                    emailVerified: googleUser.email_verified,
                    phone: userProfile ? userProfile.phone : '',
                    defaultLocation: userProfile ? userProfile.defaultLocation : '',
                    phoneRegistered: userProfile ? userProfile.phoneRegistered || false : false,
                    locationUpdated: userProfile ? userProfile.locationUpdated || false : false,
                    createdAt: userProfile ? userProfile.createdAt : new Date().toISOString(),
                    lastLogin: new Date().toISOString()
                };
                
                localStorage.setItem('dsog_delivery_profile', JSON.stringify(userProfile));
                hideGoogleSignInModal();
                showNotification(`Welcome ${googleUser.name}!`, 'success');
                
                // Check if phone number is registered
                if (!userProfile.phoneRegistered) {
                    showRegistrationModal();
                } else {
                    showMainContent();
                    updateUserProfileUI();
                    autoFillRequestForm();
                    setupNavigation();
                    loadUserDeliveryHistory();
                }
            } else {
                console.error('Failed to decode Google Sign-in response');
                showNotification('Failed to sign in with Google. Please try again.', 'error');
            }
        }
        
        function decodeJWTResponse(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                return JSON.parse(jsonPayload);
            } catch (error) {
                console.error('Error decoding JWT:', error);
                return null;
            }
        }
        
        function showGoogleSignInModal() {
            const signinModal = document.getElementById('googleSigninModal');
            const overlay = document.getElementById('contentOverlay');
            const header = document.querySelector('header');
            signinModal.classList.add('active');
            overlay.style.display = 'flex';
            header.style.display = 'none';
            document.body.style.overflow = 'hidden';
        }
        
        function hideGoogleSignInModal() {
            const signinModal = document.getElementById('googleSigninModal');
            const overlay = document.getElementById('contentOverlay');
            const mainContent = document.getElementById('mainContent');
            const header = document.querySelector('header');
            signinModal.classList.remove('active');
            overlay.style.display = 'none';
            header.style.display = 'block';
            mainContent.style.display = 'block';
            document.body.style.overflow = 'auto';
        }
        
        // User Registration (Phone Number Collection)
        function initRegistrationModal() {
            const registrationModal = document.getElementById('userRegistrationModal');
            const registrationClose = document.getElementById('registrationClose');
            
            if (registrationClose) {
                registrationClose.addEventListener('click', closeRegistrationModal);
            }
            
            if (registrationModal) {
                registrationModal.addEventListener('click', function(e) {
                    if (e.target === registrationModal) {
                        closeRegistrationModal();
                    }
                });
            }
            
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && registrationModal.classList.contains('active')) {
                    closeRegistrationModal();
                }
            });
        }
        
        function showRegistrationModal() {
            if (!userProfile || !userProfile.googleId) return;
            
            const registrationModal = document.getElementById('userRegistrationModal');
            const registrationAvatar = document.getElementById('registrationAvatar');
            
            if (!registrationModal || !registrationAvatar) return;
            
            // Set avatar
            if (userProfile.picture) {
                registrationAvatar.innerHTML = `<img src="${userProfile.picture}" alt="${userProfile.name}">`;
            } else {
                const initials = userProfile.name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
                registrationAvatar.textContent = initials;
                registrationAvatar.style.background = 'linear-gradient(135deg, var(--primary-green), var(--primary-gold))';
            }
            
            // Pre-fill phone if available
            const phoneField = document.getElementById('userPhone');
            if (phoneField && userProfile.phone) {
                phoneField.value = userProfile.phone;
            }
            
            // Pre-fill location if available
            const locationField = document.getElementById('userLocation');
            if (locationField && userProfile.defaultLocation) {
                locationField.value = userProfile.defaultLocation;
            }
            
            registrationModal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        
        function closeRegistrationModal() {
            const registrationModal = document.getElementById('userRegistrationModal');
            if (registrationModal) {
                registrationModal.classList.remove('active');
            }
            document.body.style.overflow = 'auto';
        }
        
        function completeRegistration() {
            const phoneField = document.getElementById('userPhone');
            const locationField = document.getElementById('userLocation');
            
            if (!phoneField || !locationField) return;
            
            const phone = phoneField.value.trim();
            const location = locationField.value.trim();
            
            // Validate phone number
            if (!phone) {
                showNotification('Please enter your phone number', 'error');
                return;
            }
            
            // Validate location
            if (!location) {
                showNotification('Please enter your default location', 'error');
                return;
            }
            
            // Update user profile
            userProfile.phone = phone;
            userProfile.defaultLocation = location;
            userProfile.phoneRegistered = true;
            userProfile.locationUpdated = true;
            
            localStorage.setItem('dsog_delivery_profile', JSON.stringify(userProfile));
            
            closeRegistrationModal();
            showMainContent();
            updateUserProfileUI();
            autoFillRequestForm();
            setupNavigation();
            loadUserDeliveryHistory();
            
            showNotification('Registration completed successfully!');
        }
        
        // Load delivery assistants filtered by location
        async function loadDeliveryAssistants() {
            const loadingElement = document.getElementById('assistantsLoading');
            const gridElement = document.getElementById('assistantsGrid');
            const noAssistantsElement = document.getElementById('noAssistants');
            const assistantCount = document.getElementById('assistantCount');
            
            if (!loadingElement || !gridElement || !noAssistantsElement || !assistantCount) return;
            
            // Check if location is set
            if (!userLocation || !userLocation.address) {
                showLocationWarning();
                return;
            }
            
            loadingElement.classList.add('visible');
            gridElement.innerHTML = '';
            noAssistantsElement.style.display = 'none';
            hideLocationWarning();
            
            try {
                console.log('📡 Loading delivery assistants filtered by location...');
                console.log('User location:', userLocation);
                
                const scriptUrl = 'https://script.google.com/macros/s/AKfycbzmBoCu_jXpp8oKpNAnX7Ly-bqvfdfhgiHge74ZW0oYae0wUlZERDERJYB-ZC76J9kQYQ/exec';
                
                const response = await fetch(`${scriptUrl}?action=getDeliveryAssistants&timestamp=${Date.now()}`, {
                    method: 'GET',
                    mode: 'cors'
                });
                
                console.log('Response status:', response.status);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('API Response:', result);
                    
                    let assistants = [];
                    
                    if (result && result.success && Array.isArray(result.data)) {
                        assistants = result.data.map(assistant => ({
                            id: assistant.id || assistant.assistant_id || `DA-${Date.now()}_${Math.random().toString(36).substr(2, 6)}`,
                            name: assistant.name || assistant.assistant_name || 'Unknown Assistant',
                            phone: assistant.phone || assistant.phone_number || '+254700000000',
                            vehicle: assistant.vehicle || assistant.vehicle_type || 'Vehicle not specified',
                            status: assistant.status || 'available',
                            currentCapacity: parseInt(assistant.currentCapacity || assistant.current_capacity || 0),
                            maxCapacity: parseInt(assistant.maxCapacity || assistant.max_capacity || 10),
                            rating: parseFloat(assistant.rating || 4.5),
                            completedDeliveries: parseInt(assistant.completedDeliveries || assistant.completed_deliveries || 0),
                            location: assistant.location || assistant.area || 'Location not specified',
                            area: assistant.area || assistant.zone || assistant.location || 'Central',
                            zones: Array.isArray(assistant.zones) ? assistant.zones : 
                                   (assistant.zones ? assistant.zones.split(',') : 
                                   (assistant.areas ? assistant.areas.split(',') : [])),
                            lastUpdated: assistant.lastUpdated || assistant.last_updated || new Date().toISOString(),
                            isActive: assistant.isActive !== false && assistant.active !== false,
                            notes: assistant.notes || ''
                        }));
                        
                        console.log(`✅ Successfully loaded ${assistants.length} assistants from backend`);
                        
                    } else {
                        console.log('API returned invalid data format, using fallback');
                        if (result && Array.isArray(result)) {
                            assistants = result.map(item => ({
                                id: item.id || `DA-${Date.now()}_${Math.random().toString(36).substr(2, 6)}`,
                                name: item.name || 'Unknown Assistant',
                                phone: item.phone || '+254700000000',
                                vehicle: item.vehicle || 'Vehicle not specified',
                                status: item.status || 'available',
                                currentCapacity: parseInt(item.currentCapacity || 0),
                                maxCapacity: parseInt(item.maxCapacity || 10),
                                rating: parseFloat(item.rating || 4.5),
                                completedDeliveries: parseInt(item.completedDeliveries || 0),
                                location: item.location || 'Location not specified',
                                area: item.area || 'Central',
                                zones: item.zones || [],
                                lastUpdated: item.lastUpdated || new Date().toISOString(),
                                isActive: true,
                                notes: item.notes || ''
                            }));
                            console.log(`✅ Extracted ${assistants.length} assistants from array response`);
                        } else {
                            // Use sample data
                            assistants = getSampleAssistants();
                        }
                    }
                } else {
                    console.log('Network response not ok, using sample data');
                    assistants = getSampleAssistants();
                }
                
            } catch (error) {
                console.error('❌ Error loading assistants:', error);
                console.log('Using sample assistant data as fallback');
                assistants = getSampleAssistants();
            }
            
            // Filter assistants by location
            deliveryAssistants = filterAssistantsByLocation(assistants, userLocation.zone);
            
            console.log(`📍 Filtered to ${deliveryAssistants.length} assistants in ${userLocation.zone} zone`);
            
            // Update display info
            if (assistantCount) {
                if (deliveryAssistants.length === 0) {
                    assistantCount.textContent = `No assistants available in ${userLocation.zone}`;
                } else {
                    assistantCount.textContent = `${deliveryAssistants.length} assistant${deliveryAssistants.length !== 1 ? 's' : ''} available in ${userLocation.zone}`;
                }
            }
            
            // Apply current filter
            filterAssistants(currentFilterMode);
            
            // Hide loading indicator
            loadingElement.classList.remove('visible');
            
            // If no assistants after filtering, show message
            if (deliveryAssistants.length === 0) {
                noAssistantsElement.style.display = 'block';
            }
        }
        
        function filterAssistantsByLocation(assistants, userZone) {
            return assistants.filter(assistant => {
                // Check if assistant is active
                if (assistant.isActive === false || assistant.status === 'offline') {
                    return false;
                }
                
                // Check if assistant has capacity
                if (assistant.currentCapacity >= assistant.maxCapacity) {
                    return false;
                }
                
                // Check if assistant serves the user's zone
                const assistantZones = Array.isArray(assistant.zones) ? assistant.zones : [];
                const assistantArea = assistant.area || '';
                
                // Check if assistant's zones include user's zone
                if (assistantZones.length > 0) {
                    const zoneMatch = assistantZones.some(zone => 
                        zone.toLowerCase().includes(userZone.toLowerCase()) ||
                        userZone.toLowerCase().includes(zone.toLowerCase())
                    );
                    if (zoneMatch) return true;
                }
                
                // Check if assistant's area matches user's zone
                if (assistantArea && assistantArea.toLowerCase().includes(userZone.toLowerCase())) {
                    return true;
                }
                
                // Check for common zone mappings
                const zoneVariations = {
                    'Central': ['cbd', 'central', 'nairobi', 'downtown'],
                    'West': ['west', 'westlands', 'parklands', 'lavington', 'ruaka'],
                    'South': ['south', 'industrial', 'langata', 'karen'],
                    'East': ['east', 'thika', 'ruiru', 'juja'],
                    'North East': ['eastleigh', 'pangani', 'huruma'],
                    'South West': ['south west', 'karen', 'langata', 'rongai']
                };
                
                if (zoneVariations[userZone]) {
                    for (const variation of zoneVariations[userZone]) {
                        if (assistantArea && assistantArea.toLowerCase().includes(variation)) {
                            return true;
                        }
                        for (const zone of assistantZones) {
                            if (zone.toLowerCase().includes(variation)) {
                                return true;
                            }
                        }
                    }
                }
                
                return false;
            });
        }
        
        function getSampleAssistants() {
            return [
                {
                    id: 'DA001',
                    name: 'John Kamau',
                    phone: '+254712345678',
                    vehicle: 'Toyota Probox - KDA 123A',
                    status: 'available',
                    currentCapacity: 3,
                    maxCapacity: 10,
                    rating: 4.8,
                    completedDeliveries: 120,
                    location: 'Nairobi CBD',
                    area: 'Central',
                    zones: ['Nairobi CBD', 'Upper Hill', 'Westlands'],
                    lastUpdated: new Date().toISOString(),
                    isActive: true,
                    notes: 'Reliable and punctual'
                },
                {
                    id: 'DA002',
                    name: 'Susan Wanjiku',
                    phone: '+254723456789',
                    vehicle: 'Suzuki Every - KCB 456B',
                    status: 'available',
                    currentCapacity: 5,
                    maxCapacity: 8,
                    rating: 4.9,
                    completedDeliveries: 95,
                    location: 'Westlands',
                    area: 'West',
                    zones: ['Westlands', 'Parklands', 'Lavington'],
                    lastUpdated: new Date().toISOString(),
                    isActive: true,
                    notes: 'Excellent customer service'
                },
                {
                    id: 'DA003',
                    name: 'Peter Odhiambo',
                    phone: '+254734567890',
                    vehicle: 'Nissan NV350 - KDC 789C',
                    status: 'available',
                    currentCapacity: 8,
                    maxCapacity: 12,
                    rating: 4.7,
                    completedDeliveries: 150,
                    location: 'Industrial Area',
                    area: 'South',
                    zones: ['Industrial Area', 'South B', 'South C'],
                    lastUpdated: new Date().toISOString(),
                    isActive: true,
                    notes: 'Handles large orders efficiently'
                },
                {
                    id: 'DA004',
                    name: 'Mary Achieng',
                    phone: '+254745678901',
                    vehicle: 'Toyota Sienta - KDD 012D',
                    status: 'available',
                    currentCapacity: 2,
                    maxCapacity: 6,
                    rating: 4.6,
                    completedDeliveries: 80,
                    location: 'Karen',
                    area: 'South West',
                    zones: ['Karen', 'Langata', 'Rongai'],
                    lastUpdated: new Date().toISOString(),
                    isActive: true,
                    notes: 'Specializes in fragile items'
                },
                {
                    id: 'DA005',
                    name: 'David Mwangi',
                    phone: '+254756789012',
                    vehicle: 'Toyota Hiace - KDE 345E',
                    status: 'available',
                    currentCapacity: 4,
                    maxCapacity: 15,
                    rating: 4.5,
                    completedDeliveries: 200,
                    location: 'Thika',
                    area: 'East',
                    zones: ['Thika', 'Ruiru', 'Juja'],
                    lastUpdated: new Date().toISOString(),
                    isActive: true,
                    notes: 'Long distance specialist'
                }
            ];
        }
        
        // Filter assistants based on mode
        function filterAssistants(mode) {
            currentFilterMode = mode;
            
            // Update active filter button
            document.querySelectorAll('.sort-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            const filterButton = document.getElementById(`sort${mode.charAt(0).toUpperCase() + mode.slice(1)}`);
            if (filterButton) filterButton.classList.add('active');
            
            let filteredAssistants = [...deliveryAssistants];
            
            switch(mode) {
                case 'rating':
                    filteredAssistants.sort((a, b) => b.rating - a.rating);
                    break;
                    
                case 'distance':
                    filteredAssistants.sort((a, b) => a.currentCapacity - b.currentCapacity);
                    break;
                    
                case 'all':
                default:
                    filteredAssistants.sort((a, b) => {
                        if (a.status === 'available' && b.status !== 'available') return -1;
                        if (a.status !== 'available' && b.status === 'available') return 1;
                        return b.rating - a.rating;
                    });
                    break;
            }
            
            displayAssistants(filteredAssistants);
        }
        
        function displayAssistants(assistants) {
            const gridElement = document.getElementById('assistantsGrid');
            const noAssistantsElement = document.getElementById('noAssistants');
            
            if (!gridElement || !noAssistantsElement) return;
            
            if (assistants.length === 0) {
                gridElement.innerHTML = '';
                noAssistantsElement.style.display = 'block';
                return;
            }
            
            gridElement.innerHTML = '';
            noAssistantsElement.style.display = 'none';
            
            assistants.forEach(assistant => {
                const capacityPercentage = (assistant.currentCapacity / assistant.maxCapacity) * 100;
                let capacityClass = 'capacity-low';
                if (capacityPercentage > 60) capacityClass = 'capacity-medium';
                if (capacityPercentage > 80) capacityClass = 'capacity-high';
                
                const card = document.createElement('div');
                card.className = 'assistant-card';
                card.dataset.assistantId = assistant.id;
                
                card.innerHTML = `
                    <div class="assistant-card-header">
                        <span class="assistant-status status-${assistant.status}">${assistant.status}</span>
                        <h3 class="assistant-name">${assistant.name}</h3>
                        <p class="assistant-id">ID: ${assistant.id}</p>
                        <div class="assistant-vehicle">
                            <i class="fas fa-car"></i>
                            <span>${assistant.vehicle}</span>
                        </div>
                    </div>
                    <div class="assistant-card-body">
                        <div class="assistant-info">
                            <div class="assistant-detail">
                                <span>Phone:</span>
                                <span>${assistant.phone}</span>
                            </div>
                            <div class="assistant-detail">
                                <span>Location:</span>
                                <span>${assistant.location}</span>
                            </div>
                            <div class="assistant-detail">
                                <span>Zone:</span>
                                <span>${assistant.area}</span>
                            </div>
                            <div class="assistant-detail">
                                <span>Rating:</span>
                                <div class="assistant-rating">
                                    <i class="fas fa-star"></i>
                                    <span>${assistant.rating} (${assistant.completedDeliveries} deliveries)</span>
                                </div>
                            </div>
                            <div class="capacity-bar">
                                <div class="capacity-label">
                                    <span>Current Load:</span>
                                    <span>${assistant.currentCapacity}/${assistant.maxCapacity}</span>
                                </div>
                                <div class="capacity-progress">
                                    <div class="capacity-fill ${capacityClass}" style="width: ${capacityPercentage}%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="assistant-actions">
                            <button class="assign-btn" onclick="selectAssistantFromCard('${assistant.id}')">
                                <i class="fas fa-truck-loading"></i>
                                Select Assistant
                            </button>
                            <button class="whatsapp-btn" onclick="window.open('https://wa.me/${assistant.phone.replace(/\D/g, '')}', '_blank')">
                                <i class="fab fa-whatsapp"></i>
                            </button>
                        </div>
                    </div>
                `;
                
                gridElement.appendChild(card);
            });
        }
        
        function selectAssistantFromCard(assistantId) {
            const assistant = deliveryAssistants.find(a => a.id === assistantId);
            
            if (assistant) {
                selectAssistant(assistant);
            }
        }
        
        function selectAssistant(assistant) {
            selectedAssistant = assistant;
            
            // Remove selected class from all assistant cards
            document.querySelectorAll('.assistant-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Add selected class to clicked assistant card
            const selectedCard = document.querySelector(`[data-assistant-id="${assistant.id}"]`);
            if (selectedCard) {
                selectedCard.classList.add('selected');
            }
            
            // Validate step 3
            validateStep3();
            
            showNotification(`Selected assistant: ${assistant.name}`);
        }
        
        // User Profile Functions
        function showMainContent() {
            const overlay = document.getElementById('contentOverlay');
            const mainContent = document.getElementById('mainContent');
            const bottomNav = document.querySelector('.bottom-nav');
            const userProfileHeader = document.getElementById('userProfileHeader');
            const header = document.querySelector('header');
            
            if (overlay) overlay.style.display = 'none';
            if (mainContent) mainContent.style.display = 'block';
            if (bottomNav) bottomNav.style.display = 'block';
            if (userProfileHeader) userProfileHeader.style.display = 'flex';
            if (header) header.style.display = 'block';
            
            updateUserProfileUI();
            autoFillRequestForm();
            setupNavigation();
            loadUserDeliveryHistory();
        }
        
        function updateUserPhone() {
            if (!userProfile || !userProfile.googleId) return;
            
            const currentPhone = userProfile.phone || '';
            const newPhone = prompt(
                'Enter your new phone number (WhatsApp):',
                currentPhone
            );
            
            if (newPhone !== null && newPhone.trim() !== '') {
                userProfile.phone = newPhone.trim();
                userProfile.phoneRegistered = true;
                localStorage.setItem('dsog_delivery_profile', JSON.stringify(userProfile));
                updateUserProfileUI();
                autoFillRequestForm();
                showNotification('Phone number updated successfully!');
            }
            closeProfileModal();
        }
        
        function updateUserLocation() {
            if (!userProfile || !userProfile.googleId) return;
            
            const currentLocation = userProfile.defaultLocation || '';
            const newLocation = prompt(
                'Enter your new default pickup location:',
                currentLocation
            );
            
            if (newLocation !== null && newLocation.trim() !== '') {
                userProfile.defaultLocation = newLocation.trim();
                userProfile.locationUpdated = true;
                localStorage.setItem('dsog_delivery_profile', JSON.stringify(userProfile));
                updateUserProfileUI();
                autoFillRequestForm();
                showNotification('Default location updated successfully!');
            }
            closeProfileModal();
        }
        
        function autoFillRequestForm() {
            if (userProfile) {
                const nameField = document.getElementById('customerName');
                const phoneField = document.getElementById('customerPhone');
                const pickupField = document.getElementById('pickupLocation');
                const manualLocationInput = document.getElementById('manualLocationInput');
                
                if (nameField && userProfile.name) {
                    nameField.value = userProfile.name;
                }
                
                if (phoneField && userProfile.phone) {
                    phoneField.value = userProfile.phone;
                }
                
                if (pickupField && userProfile.defaultLocation) {
                    pickupField.value = userProfile.defaultLocation;
                }
                
                if (manualLocationInput && userProfile.defaultLocation) {
                    manualLocationInput.value = userProfile.defaultLocation;
                }
            }
        }
        
        function updateUserProfileUI() {
            if (userProfile) {
                const userAvatar = document.getElementById('userAvatar');
                const userNameDisplay = document.getElementById('userNameDisplay');
                const profileAvatar = document.getElementById('profileAvatar');
                const profileName = document.getElementById('profileName');
                const profileInfo = document.getElementById('profileInfo');
                
                if (userProfile.picture) {
                    if (userAvatar) {
                        userAvatar.innerHTML = `<img src="${userProfile.picture}" alt="${userProfile.name}">`;
                    }
                    if (profileAvatar) {
                        profileAvatar.innerHTML = `<img src="${userProfile.picture}" alt="${userProfile.name}">`;
                    }
                } else {
                    const initials = userProfile.name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
                    
                    if (userAvatar) {
                        userAvatar.textContent = initials;
                        userAvatar.style.background = 'linear-gradient(135deg, var(--primary-green), var(--primary-gold))';
                    }
                    
                    if (profileAvatar) {
                        profileAvatar.textContent = initials;
                        profileAvatar.style.background = 'linear-gradient(135deg, var(--primary-green), var(--primary-gold))';
                    }
                }
                
                if (userNameDisplay) {
                    userNameDisplay.textContent = userProfile.givenName || userProfile.name.split(' ')[0];
                }
                
                if (profileName) {
                    profileName.textContent = userProfile.name;
                }
                
                if (profileInfo) {
                    profileInfo.innerHTML = `
                        <div style="margin-bottom: 1rem;">
                            <span style="font-weight: 600; color: var(--text-secondary);">Full Name:</span>
                            <div style="margin-top: 0.3rem; font-weight: 500;">${userProfile.name}</div>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <span style="font-weight: 600; color: var(--text-secondary);">Email:</span>
                            <div style="margin-top: 0.3rem; font-weight: 500;">${userProfile.email}</div>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <span style="font-weight: 600; color: var(--text-secondary);">Phone:</span>
                            <div style="margin-top: 0.3rem; font-weight: 500;">${userProfile.phone || 'Not set'}</div>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <span style="font-weight: 600; color: var(--text-secondary);">Default Location:</span>
                            <div style="margin-top: 0.3rem; font-weight: 500;">${userProfile.defaultLocation || 'Not set'}</div>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <span style="font-weight: 600; color: var(--text-secondary);">Account Created:</span>
                            <div style="margin-top: 0.3rem; font-weight: 500;">${new Date(userProfile.createdAt).toLocaleDateString()}</div>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <span style="font-weight: 600; color: var(--text-secondary);">Last Login:</span>
                            <div style="margin-top: 0.3rem; font-weight: 500;">${new Date(userProfile.lastLogin).toLocaleDateString()}</div>
                        </div>
                    `;
                }
            }
        }
        
        function initProfileModal() {
            const profileModal = document.getElementById('userProfileModal');
            const profileClose = document.getElementById('profileClose');
            
            if (profileClose) {
                profileClose.addEventListener('click', closeProfileModal);
            }
            
            if (profileModal) {
                profileModal.addEventListener('click', function(e) {
                    if (e.target === profileModal) {
                        closeProfileModal();
                    }
                });
            }
            
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && profileModal && profileModal.classList.contains('active')) {
                    closeProfileModal();
                }
            });
        }
        
        function openProfileModal() {
            if (!userProfile || !userProfile.googleId) {
                showNotification('Please sign in first', 'error');
                return;
            }
            
            const profileModal = document.getElementById('userProfileModal');
            if (!profileModal) return;
            
            updateUserProfileUI();
            profileModal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        
        function closeProfileModal() {
            const profileModal = document.getElementById('userProfileModal');
            if (profileModal) {
                profileModal.classList.remove('active');
            }
            document.body.style.overflow = 'auto';
        }
        
        function signOut() {
            if (confirm('Are you sure you want to sign out?')) {
                const savedPhone = userProfile.phone;
                const savedLocation = userProfile.defaultLocation;
                const savedPhoneRegistered = userProfile.phoneRegistered;
                
                userProfile = null;
                googleUser = null;
                googleToken = null;
                
                localStorage.removeItem('dsog_delivery_profile');
                
                const mainContent = document.getElementById('mainContent');
                const bottomNav = document.querySelector('.bottom-nav');
                const userProfileHeader = document.getElementById('userProfileHeader');
                const header = document.querySelector('header');
                
                if (mainContent) mainContent.style.display = 'none';
                if (bottomNav) bottomNav.style.display = 'none';
                if (userProfileHeader) userProfileHeader.style.display = 'none';
                if (header) header.style.display = 'none';
                
                showGoogleSignInModal();
                showNotification('Signed out successfully');
            }
        }
        
        // Initialize Confirmation Modal
        function initConfirmationModal() {
            const confirmationModal = document.getElementById('confirmationModal');
            const confirmationClose = document.getElementById('confirmationClose');
            
            if (confirmationClose) {
                confirmationClose.addEventListener('click', closeConfirmationModal);
            }
            
            if (confirmationModal) {
                confirmationModal.addEventListener('click', function(e) {
                    if (e.target === confirmationModal) {
                        closeConfirmationModal();
                    }
                });
            }
            
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && confirmationModal && confirmationModal.classList.contains('active')) {
                    closeConfirmationModal();
                }
            });
        }
        
        function openConfirmationModal() {
            const confirmationModal = document.getElementById('confirmationModal');
            if (confirmationModal) {
                confirmationModal.classList.add('active');
                document.body.style.overflow = 'hidden';
            }
        }
        
        function closeConfirmationModal() {
            const confirmationModal = document.getElementById('confirmationModal');
            if (confirmationModal) {
                confirmationModal.classList.remove('active');
            }
            document.body.style.overflow = 'auto';
        }
        
        // Confirm Pickup Request
        function confirmPickupRequest() {
            if (!userProfile || !userProfile.googleId) {
                showNotification('Please sign in first', 'error');
                return;
            }
            
            // Validate all steps
            if (!validateStep(1) || !validateStep(2) || !validateStep(3)) {
                showNotification('Please complete all steps before confirming', 'error');
                return;
            }
            
            const customerName = document.getElementById('customerName');
            const customerPhone = document.getElementById('customerPhone');
            const pickupLocation = document.getElementById('pickupLocation');
            const deliveryLocation = document.getElementById('deliveryLocation');
            const itemDescription = document.getElementById('itemDescription');
            const specialInstructions = document.getElementById('specialInstructions');
            const deliveryDistance = document.getElementById('deliveryDistance');
            const packageWeight = document.getElementById('packageWeight');
            
            if (!customerName || !customerPhone || !pickupLocation || !deliveryLocation || 
                !itemDescription || !deliveryDistance || !packageWeight) return;
            
            const customerNameValue = customerName.value.trim();
            const customerPhoneValue = customerPhone.value.trim();
            const pickupLocationValue = pickupLocation.value.trim();
            const deliveryLocationValue = deliveryLocation.value.trim();
            const itemDescriptionValue = itemDescription.value.trim();
            const specialInstructionsValue = specialInstructions ? specialInstructions.value.trim() : '';
            const distanceZone = deliveryDistance.value;
            const weight = packageWeight.value;
            
            // Generate tracking number
            const trackingNumber = 'DSOG-' + Date.now().toString().slice(-6);
            
            // Build confirmation message
            const confirmationBody = document.getElementById('confirmationBody');
            if (!confirmationBody) return;
            
            const distanceZoneLabels = {
                same: 'Same Region (0-5km)',
                nearby: 'Nearby Region (5-10km)',
                far: 'Far Region (10-20km)',
                distant: 'Distant Region (20+ km)'
            };
            
            confirmationBody.innerHTML = `
                <div class="confirmation-details">
                    <h3>Pickup Request Details</h3>
                    <div style="display: grid; gap: 1rem;">
                        <div>
                            <span style="font-weight: 600; color: var(--text-secondary);">Tracking Number:</span>
                            <div style="margin-top: 0.3rem; font-weight: 700; color: var(--primary-green);">${trackingNumber}</div>
                        </div>
                        <div>
                            <span style="font-weight: 600; color: var(--text-secondary);">Customer:</span>
                            <div style="margin-top: 0.3rem;">${customerNameValue} | ${customerPhoneValue}</div>
                        </div>
                        <div>
                            <span style="font-weight: 600; color: var(--text-secondary);">Selected Assistant:</span>
                            <div style="margin-top: 0.3rem;">
                                ${selectedAssistant.name} (${selectedAssistant.phone})
                                <div style="font-size: 0.9rem; color: var(--text-secondary);">
                                    <i class="fas fa-info-circle"></i> You will communicate directly with this assistant via WhatsApp
                                </div>
                            </div>
                        </div>
                        <div>
                            <span style="font-weight: 600; color: var(--text-secondary);">Pickup:</span>
                            <div style="margin-top: 0.3rem;">${pickupLocationValue}</div>
                        </div>
                        <div>
                            <span style="font-weight: 600; color: var(--text-secondary);">Delivery:</span>
                            <div style="margin-top: 0.3rem;">${deliveryLocationValue}</div>
                        </div>
                        <div>
                            <span style="font-weight: 600; color: var(--text-secondary);">Package:</span>
                            <div style="margin-top: 0.3rem;">${selectedPackageType.charAt(0).toUpperCase() + selectedPackageType.slice(1)} - ${selectedPackageSize} (${weight}kg)</div>
                        </div>
                        <div>
                            <span style="font-weight: 600; color: var(--text-secondary);">Distance Zone:</span>
                            <div style="margin-top: 0.3rem;">${distanceZoneLabels[distanceZone] || distanceZone}</div>
                        </div>
                        <div>
                            <span style="font-weight: 600; color: var(--text-secondary);">Items:</span>
                            <div style="margin-top: 0.3rem;">${itemDescriptionValue}</div>
                        </div>
                        ${specialInstructionsValue ? `
                        <div>
                            <span style="font-weight: 600; color: var(--text-secondary);">Special Instructions:</span>
                            <div style="margin-top: 0.3rem;">${specialInstructionsValue}</div>
                        </div>
                        ` : ''}
                        <div style="background: linear-gradient(135deg, rgba(212, 175, 55, 0.1), rgba(37, 211, 102, 0.1)); padding: 1rem; border-radius: 8px; border-left: 4px solid var(--primary-gold); margin-top: 1rem;">
                            <h4 style="color: var(--primary-gold); margin-bottom: 0.8rem;">Delivery Charges</h4>
                            <div style="display: grid; gap: 0.5rem;">
                                <div style="display: flex; justify-content: space-between;">
                                    <span>Base Charge:</span>
                                    <span style="font-weight: 600;">Ksh ${currentCharges.baseCharge}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span>Distance Surcharge:</span>
                                    <span style="font-weight: 600;">Ksh ${currentCharges.distanceSurcharge}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span>Weight Surcharge:</span>
                                    <span style="font-weight: 600;">Ksh ${currentCharges.weightSurcharge}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; border-top: 1px solid rgba(0,0,0,0.1); padding-top: 0.5rem; margin-top: 0.5rem;">
                                    <span style="font-weight: 700;">Total Charge:</span>
                                    <span style="font-weight: 700; color: var(--primary-green); font-size: 1.1rem;">Ksh ${currentCharges.totalCharge}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div style="background: rgba(37, 211, 102, 0.1); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; border-left: 4px solid var(--primary-green);">
                    <div style="font-weight: 600; color: var(--primary-green); margin-bottom: 0.5rem;">
                        <i class="fab fa-whatsapp"></i> WhatsApp Tracking Enabled
                    </div>
                    <div style="font-size: 0.9rem; color: var(--text-secondary);">
                        After confirmation, you will be redirected to WhatsApp to message the assistant directly. Save their number for tracking updates.
                    </div>
                </div>
                
                <div class="confirmation-actions">
                    <button class="cancel-btn" onclick="closeConfirmationModal()">Cancel</button>
                    <button class="confirm-btn" onclick="submitPickupRequestViaWhatsApp('${trackingNumber}')">
                        <i class="fab fa-whatsapp"></i> Open WhatsApp
                    </button>
                </div>
            `;
            
            openConfirmationModal();
        }
        
        // Submit Pickup Request via WhatsApp
        function submitPickupRequestViaWhatsApp(trackingNumber) {
            if (!userProfile || !userProfile.googleId) {
                showNotification('Please sign in first', 'error');
                return;
            }
            
            // Get form values
            const customerName = document.getElementById('customerName');
            const customerPhone = document.getElementById('customerPhone');
            const pickupLocation = document.getElementById('pickupLocation');
            const deliveryLocation = document.getElementById('deliveryLocation');
            const itemDescription = document.getElementById('itemDescription');
            const specialInstructions = document.getElementById('specialInstructions');
            const deliveryDistance = document.getElementById('deliveryDistance');
            const packageWeight = document.getElementById('packageWeight');
            
            if (!customerName || !customerPhone || !pickupLocation || !deliveryLocation || 
                !itemDescription || !selectedAssistant || 
                !deliveryDistance || !packageWeight) return;
            
            const customerNameValue = customerName.value.trim();
            const customerPhoneValue = customerPhone.value.trim();
            const pickupLocationValue = pickupLocation.value.trim();
            const deliveryLocationValue = deliveryLocation.value.trim();
            const itemDescriptionValue = itemDescription.value.trim();
            const specialInstructionsValue = specialInstructions ? specialInstructions.value.trim() : '';
            const distanceZone = deliveryDistance.value;
            const weight = packageWeight.value;
            
            // Build WhatsApp message for the assistant
            let whatsappMessage = `*📦 NEW PICKUP REQUEST - DSOG DELIVERY*%0A%0A`;
            whatsappMessage += `*Tracking:* ${trackingNumber}%0A`;
            whatsappMessage += `*Date:* ${new Date().toLocaleDateString()}%0A`;
            whatsappMessage += `*Time:* ${new Date().toLocaleTimeString()}%0A%0A`;
            
            whatsappMessage += `*👤 CUSTOMER DETAILS*%0A`;
            whatsappMessage += `Name: ${customerNameValue}%0A`;
            whatsappMessage += `Phone: ${customerPhoneValue}%0A`;
            whatsappMessage += `Email: ${userProfile.email}%0A%0A`;
            
            whatsappMessage += `*📍 PICKUP LOCATION*%0A`;
            whatsappMessage += `${pickupLocationValue}%0A%0A`;
            
            whatsappMessage += `*🎯 DELIVERY DESTINATION*%0A`;
            whatsappMessage += `${deliveryLocationValue}%0A%0A`;
            
            whatsappMessage += `*📦 PACKAGE DETAILS*%0A`;
            whatsappMessage += `Type: ${selectedPackageType.charAt(0).toUpperCase() + selectedPackageType.slice(1)}%0A`;
            whatsappMessage += `Size: ${selectedPackageSize}%0A`;
            whatsappMessage += `Weight: ${weight}kg%0A`;
            whatsappMessage += `Items: ${itemDescriptionValue}%0A%0A`;
            
            whatsappMessage += `*💰 DELIVERY CHARGES*%0A`;
            whatsappMessage += `Base Charge: Ksh ${currentCharges.baseCharge}%0A`;
            whatsappMessage += `Distance Surcharge: Ksh ${currentCharges.distanceSurcharge}%0A`;
            whatsappMessage += `Weight Surcharge: Ksh ${currentCharges.weightSurcharge}%0A`;
            whatsappMessage += `*Total: Ksh ${currentCharges.totalCharge}*%0A%0A`;
            
            if (specialInstructionsValue) {
                whatsappMessage += `*📝 SPECIAL INSTRUCTIONS*%0A`;
                whatsappMessage += `${specialInstructionsValue}%0A%0A`;
            }
            
            whatsappMessage += `_Please confirm pickup time and provide ETA_%0A`;
            whatsappMessage += `_Customer will track delivery via this WhatsApp conversation_%0A`;
            whatsappMessage += `_Payment: Cash on Delivery (Ksh ${currentCharges.totalCharge})_`;
            
            // Open WhatsApp with the selected assistant
            const assistantPhone = selectedAssistant.phone.replace(/\D/g, '');
            const whatsappUrl = `https://wa.me/${assistantPhone}?text=${whatsappMessage}`;
            window.open(whatsappUrl, '_blank');
            
            // Also send a copy to support for backup
            let supportMessage = `*BACKUP: PICKUP REQUEST - ${selectedAssistant.name}*%0A%0A${whatsappMessage}`;
            const supportWhatsappUrl = `https://wa.me/${SUPPORT_WHATSAPP}?text=${supportMessage}`;
            window.open(supportWhatsappUrl, '_blank');
            
            // Save to local history with charges
            saveToDeliveryHistory(
                trackingNumber,
                customerNameValue,
                customerPhoneValue,
                pickupLocationValue,
                deliveryLocationValue,
                selectedPackageType,
                selectedPackageSize,
                itemDescriptionValue,
                specialInstructionsValue,
                selectedAssistant.name,
                selectedAssistant.phone,
                distanceZone,
                parseFloat(weight),
                currentCharges
            );
            
            // Close confirmation modal
            closeConfirmationModal();
            
            // Reset form and go back to step 1
            resetRequestForm();
            goToStep(1);
            
            // Show success notification
            showNotification(`Pickup request sent to ${selectedAssistant.name}! Save their number for tracking.`);
            
            // Reload history
            setTimeout(() => {
                loadUserDeliveryHistory();
            }, 1000);
        }
        
        function saveToDeliveryHistory(trackingNumber, customerName, customerPhone, pickupLocation, deliveryLocation, packageType, packageSize, itemDescription, specialInstructions, assistantName, assistantPhone, distanceZone, weight, charges) {
            const deliveryRecord = {
                trackingNumber,
                customerName,
                customerPhone,
                pickupLocation,
                deliveryLocation,
                packageType,
                packageSize,
                itemDescription,
                specialInstructions,
                assistantName,
                assistantPhone,
                distanceZone,
                weight,
                charges,
                status: 'pending',
                requestDate: new Date().toISOString(),
                googleUserId: userProfile.googleId
            };
            
            // Add to local history
            userDeliveryHistory.unshift(deliveryRecord);
            localStorage.setItem('dsog_delivery_history', JSON.stringify(userDeliveryHistory));
            
            // Also try to save to backend
            saveToBackend(deliveryRecord);
        }
        
        async function saveToBackend(deliveryRecord) {
            try {
                const response = await fetch(scriptUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'saveDeliveryRequest',
                        ...deliveryRecord
                    })
                });
                
                if (response.ok) {
                    console.log('✅ Delivery request saved to backend');
                }
            } catch (error) {
                console.error('Error saving to backend:', error);
            }
        }
        
        function resetRequestForm() {
            // Reset step 1
            const manualLocationInput = document.getElementById('manualLocationInput');
            const deliveryDistance = document.getElementById('deliveryDistance');
            const packageWeight = document.getElementById('packageWeight');
            const locationDisplay = document.getElementById('currentLocationDisplay');
            const calculatorResult = document.getElementById('calculatorResult');
            
            if (manualLocationInput) manualLocationInput.value = '';
            if (deliveryDistance) deliveryDistance.value = '';
            if (packageWeight) packageWeight.value = '';
            if (locationDisplay) locationDisplay.classList.remove('active');
            if (calculatorResult) calculatorResult.style.display = 'none';
            
            // Reset step 2
            const packageCards = document.querySelectorAll('.package-card');
            packageCards.forEach(card => card.classList.remove('selected'));
            
            const customerName = document.getElementById('customerName');
            const customerPhone = document.getElementById('customerPhone');
            const pickupLocationField = document.getElementById('pickupLocation');
            const deliveryLocation = document.getElementById('deliveryLocation');
            const itemDescription = document.getElementById('itemDescription');
            const specialInstructions = document.getElementById('specialInstructions');
            const charCount = document.getElementById('charCount');
            
            if (customerName) customerName.value = '';
            if (customerPhone) customerPhone.value = '';
            if (pickupLocationField) pickupLocationField.value = '';
            if (deliveryLocation) deliveryLocation.value = '';
            if (itemDescription) itemDescription.value = '';
            if (specialInstructions) specialInstructions.value = '';
            if (charCount) {
                charCount.textContent = '0/200';
                charCount.style.color = 'var(--gray)';
            }
            
            // Reset step 3
            const assistantCards = document.querySelectorAll('.assistant-card');
            assistantCards.forEach(card => card.classList.remove('selected'));
            
            // Reset state
            selectedAssistant = null;
            selectedPackageType = null;
            selectedPackageSize = null;
            userLocation = null;
            
            currentCharges = {
                baseCharge: 0,
                distanceSurcharge: 0,
                weightSurcharge: 0,
                totalCharge: 0,
                packageType: '',
                distanceZone: '',
                weight: 0
            };
        }
        
        // Initialize Mobile Menu
        function initMobileMenu() {
            const hamburgerBtn = document.getElementById('hamburgerBtn');
            const mobileMenu = document.getElementById('mobileMenu');
            const menuBackdrop = document.getElementById('menuBackdrop');
            const closeMenu = document.getElementById('closeMenu');
            
            function toggleMobileMenu() {
                const isOpen = mobileMenu.classList.contains('active');
                if (!isOpen) {
                    mobileMenu.classList.add('active');
                    menuBackdrop.classList.add('active');
                    hamburgerBtn.classList.add('active');
                    document.body.style.overflow = 'hidden';
                } else {
                    mobileMenu.classList.remove('active');
                    menuBackdrop.classList.remove('active');
                    hamburgerBtn.classList.remove('active');
                    document.body.style.overflow = 'auto';
                }
            }
            
            if (hamburgerBtn) {
                hamburgerBtn.addEventListener('click', toggleMobileMenu);
            }
            
            if (closeMenu) {
                closeMenu.addEventListener('click', toggleMobileMenu);
            }
            
            if (menuBackdrop) {
                menuBackdrop.addEventListener('click', toggleMobileMenu);
            }
            
            const mobileLinks = document.querySelectorAll('.mobile-nav-links a');
            mobileLinks.forEach(link => {
                link.addEventListener('click', toggleMobileMenu);
            });
        }
        
        window.closeMobileMenu = function() {
            const mobileMenu = document.getElementById('mobileMenu');
            const menuBackdrop = document.getElementById('menuBackdrop');
            const hamburgerBtn = document.getElementById('hamburgerBtn');
            
            if (mobileMenu) mobileMenu.classList.remove('active');
            if (menuBackdrop) menuBackdrop.classList.remove('active');
            if (hamburgerBtn) hamburgerBtn.classList.remove('active');
            document.body.style.overflow = 'auto';
        };
        
        // Setup Navigation
        function setupNavigation() {
            const navItems = document.querySelectorAll('.nav-item');
            
            navItems.forEach(item => {
                item.addEventListener('click', function() {
                    navItems.forEach(i => i.classList.remove('active'));
                    this.classList.add('active');
                });
            });
        }
        
        // WhatsApp Tracking System
        function openWhatsAppForHelp() {
            const whatsappUrl = `https://wa.me/${SUPPORT_WHATSAPP}?text=Hello%20DSOG%20Delivery,%20I%20need%20help%20with%20tracking%20my%20package.`;
            window.open(whatsappUrl, '_blank');
        }
        
        function trackViaWhatsApp(trackingNumber, assistantPhone) {
            const message = `Hello! I would like to track my package ${trackingNumber}. Can you please provide an update on the delivery status?`;
            const whatsappUrl = `https://wa.me/${assistantPhone.replace(/\D/g, '')}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        }
        
        // User Delivery History
        async function loadUserDeliveryHistory() {
            // This function remains the same as your original
            // Keeping it for reference but not called in the step-by-step flow
        }
        
        // PWA Installation
        function initPWA() {
            if (window.matchMedia('(display-mode: standalone)').matches || 
                window.navigator.standalone === true) {
                isAppInstalled = true;
                console.log('📱 Delivery app is installed as PWA');
                hideInstallButton();
            }
            
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                console.log('📱 PWA installation available for delivery app');
                
                setTimeout(() => {
                    if (!isAppInstalled && !isInstallPromptShown) {
                        showInstallButton();
                    }
                }, 3000);
            });
            
            window.addEventListener('appinstalled', () => {
                isAppInstalled = true;
                deferredPrompt = null;
                console.log('✅ Delivery PWA installed successfully');
                hideInstallPrompt();
                hideInstallButton();
                showNotification('Delivery app installed successfully!');
            });
            
            initInstallButtons();
            registerServiceWorker();
        }
        
        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/delivery-service-worker.js')
                    .then(registration => {
                        console.log('✅ Delivery Service Worker registered:', registration.scope);
                    })
                    .catch(error => {
                        console.log('❌ Delivery Service Worker registration failed:', error);
                    });
            }
        }
        
        function initInstallButtons() {
            const installBtn = document.getElementById('installAppBtn');
            const installNowBtn = document.getElementById('pwaInstallNow');
            const installLaterBtn = document.getElementById('pwaInstallLater');
            const installCloseBtn = document.getElementById('pwaInstallClose');
            
            if (installBtn) {
                installBtn.addEventListener('click', showInstallPrompt);
            }
            
            if (installNowBtn) {
                installNowBtn.addEventListener('click', installPWA);
            }
            
            if (installLaterBtn) {
                installLaterBtn.addEventListener('click', hideInstallPrompt);
            }
            
            if (installCloseBtn) {
                installCloseBtn.addEventListener('click', hideInstallPrompt);
            }
        }
        
        function showInstallButton() {
            const installBtn = document.getElementById('installAppBtn');
            if (installBtn) {
                installBtn.style.display = 'flex';
            }
        }
        
        function hideInstallButton() {
            const installBtn = document.getElementById('installAppBtn');
            if (installBtn) {
                installBtn.style.display = 'none';
            }
        }
        
        function showInstallPrompt() {
            if (isAppInstalled) {
                showNotification('Delivery app is already installed!');
                return;
            }
            
            if (!deferredPrompt) {
                showNotification('App installation not available on this device');
                return;
            }
            
            const installPrompt = document.getElementById('pwaInstallPrompt');
            if (installPrompt) {
                installPrompt.style.display = 'flex';
                isInstallPromptShown = true;
            }
        }
        
        function hideInstallPrompt() {
            const installPrompt = document.getElementById('pwaInstallPrompt');
            if (installPrompt) {
                installPrompt.style.display = 'none';
            }
        }
        
        async function installPWA() {
            if (!deferredPrompt) {
                showNotification('Installation not available');
                return;
            }
            
            try {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                
                if (outcome === 'accepted') {
                    console.log('✅ User accepted delivery PWA installation');
                    isAppInstalled = true;
                    hideInstallPrompt();
                    hideInstallButton();
                } else {
                    console.log('❌ User dismissed delivery PWA installation');
                }
                
                deferredPrompt = null;
            } catch (error) {
                console.error('Error installing delivery PWA:', error);
                showNotification('Error installing delivery app. Please try again.', 'error');
            }
        }
        
        // Notification system
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = 'notification';
            
            if (type === 'error') {
                notification.style.background = 'var(--error)';
            } else if (type === 'warning') {
                notification.style.background = 'var(--warning)';
                notification.style.color = 'var(--primary-black)';
            } else if (type === 'info') {
                notification.style.background = 'var(--info)';
            }
            
            notification.textContent = message;
            document.body.appendChild(notification);
            notification.classList.add('show');
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.classList.remove('show');
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.remove();
                        }
                    }, 300);
                }
            }, 3000);
        }
    </script>
</body>
</html>
